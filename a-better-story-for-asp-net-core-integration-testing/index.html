<!DOCTYPE html><html><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><link rel="preload" href="/component---src-layouts-index-js-c56dd00f07d25fed4a16.js" as="script"/><link rel="preload" href="/component---src-templates-blog-post-js-84198a550b368f49f5e5.js" as="script"/><link rel="preload" href="/path---a-better-story-for-asp-net-core-integration-testing-686a0b3d463a2424c4b4.js" as="script"/><link rel="preload" href="/app-65f6eef773a4d1949159.js" as="script"/><link rel="preload" href="/commons-052854b14b2d9cebb713.js" as="script"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><title data-react-helmet="true">A Better Story for Asp.Net Core Integration Testing | nance.io</title><meta data-react-helmet="true" property="og:title" content="A Better Story for Asp.Net Core Integration Testing | nance.io"/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" property="og:image" content="/static/fallback.9c01bf00.jpg"/><meta data-react-helmet="true" property="og:description"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:site" content="@jaredcnance"/><meta data-react-helmet="true" name="twitter:title" content="A Better Story for Asp.Net Core Integration Testing | nance.io"/><meta data-react-helmet="true" name="twitter:description" content="null"/><meta data-react-helmet="true" name="twitter:image" content="/static/fallback.9c01bf00.jpg"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:100%/1.75 'Merriweather','Georgia',serif;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.9);font-family:'Merriweather','Georgia',serif;font-weight:400;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:Montserrat,sans-serif;font-weight:900;text-rendering:optimizeLegibility;font-size:2.5rem;line-height:1.1;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.73286rem;line-height:1.1;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.4427rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;letter-spacing:0.140625em;text-transform:uppercase;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.83255rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.75966rem;line-height:1.1;font-style:italic;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}ul{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;list-style:disc;}ol{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}p{margin-left:0;margin-right:0;margin-top:1.2rem;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.2rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:0.85rem;line-height:1.75rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1rem;line-height:1.75rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}blockquote{margin-left:-1.75rem;margin-right:1.75rem;margin-top:0;padding-bottom:0;padding-left:1.42188rem;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1.20112rem;line-height:1.75rem;color:hsla(0,0%,0%,0.59);font-style:italic;border-left:0.32813rem solid hsla(0,0%,0%,0.9);}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.75rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}b{font-weight:700;}strong{font-weight:700;}dt{font-weight:700;}th{font-weight:700;}li{margin-bottom:calc(1.75rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}li > ul{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(1.75rem / 2);}code{font-size:0.85rem;line-height:1.75rem;}kbd{font-size:0.85rem;line-height:1.75rem;}samp{font-size:0.85rem;line-height:1.75rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.16667rem;padding-right:1.16667rem;padding-top:0.875rem;padding-bottom:calc(0.875rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}blockquote > :last-child{margin-bottom:0;}blockquote cite{font-size:1rem;line-height:1.75rem;color:hsla(0,0%,0%,0.9);font-weight:400;}blockquote cite:before{content:"— ";}ul,ol{margin-left:0;}@media only screen and (max-width:480px){ul,ol{margin-left:1.75rem;}blockquote{margin-left:-1.3125rem;margin-right:0;padding-left:0.98438rem;}}h1,h2,h3,h4,h5,h6{margin-top:3.5rem;}a{box-shadow:0 1px 0 0 currentColor;color:#007acc;text-decoration:none;}a:hover,a:active{box-shadow:none;}mark,ins{background:#007acc;color:white;padding:0.10938rem 0.21875rem;text-decoration:none;}a.gatsby-resp-image-link{box-shadow:none;}</style><style id="gatsby-inlined-css">code[class*=language-],pre[class*=language-]{color:#bfc7d5;background:none;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;background:#292d3e}:not(pre)>code[class*=language-]{color:#292d3e;background-color:rgba(191,199,213,.53333);padding:.1em .3em;border-radius:.3em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#697098}.token.class-name,.token.punctuation{color:#82aaff}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#ff5572}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#ffcb6b}.token.constant,.token.property,.token.symbol{color:#c3e88d}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#bf79db}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#c3e88d}.token.entity,.token.operator,.token.url{color:#80cbc4}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:#66d9ef}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:100;src:local("Montserrat Thin "),local("Montserrat-Thin"),url(/static/montserrat-latin-100.50d27986.woff2) format("woff2"),url(/static/montserrat-latin-100.5e334eff.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:100;src:local("Montserrat Thin italic"),local("Montserrat-Thinitalic"),url(/static/montserrat-latin-100italic.8c070533.woff2) format("woff2"),url(/static/montserrat-latin-100italic.03e19243.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:200;src:local("Montserrat Extra Light "),local("Montserrat-Extra Light"),url(/static/montserrat-latin-200.4343d3d9.woff2) format("woff2"),url(/static/montserrat-latin-200.f2022ecd.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:200;src:local("Montserrat Extra Light italic"),local("Montserrat-Extra Lightitalic"),url(/static/montserrat-latin-200italic.116c4c4b.woff2) format("woff2"),url(/static/montserrat-latin-200italic.89614a60.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:300;src:local("Montserrat Light "),local("Montserrat-Light"),url(/static/montserrat-latin-300.d2ad295b.woff2) format("woff2"),url(/static/montserrat-latin-300.3a371ee0.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:300;src:local("Montserrat Light italic"),local("Montserrat-Lightitalic"),url(/static/montserrat-latin-300italic.f6b6bf24.woff2) format("woff2"),url(/static/montserrat-latin-300italic.16521668.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:400;src:local("Montserrat Regular "),local("Montserrat-Regular"),url(/static/montserrat-latin-400.240a8444.woff2) format("woff2"),url(/static/montserrat-latin-400.b20cc131.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:400;src:local("Montserrat Regular italic"),local("Montserrat-Regularitalic"),url(/static/montserrat-latin-400italic.86172bb8.woff2) format("woff2"),url(/static/montserrat-latin-400italic.9405e787.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:500;src:local("Montserrat Medium "),local("Montserrat-Medium"),url(/static/montserrat-latin-500.fb8d6b71.woff2) format("woff2"),url(/static/montserrat-latin-500.50825d47.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:500;src:local("Montserrat Medium italic"),local("Montserrat-Mediumitalic"),url(/static/montserrat-latin-500italic.c0a555a4.woff2) format("woff2"),url(/static/montserrat-latin-500italic.635de59c.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:600;src:local("Montserrat SemiBold "),local("Montserrat-SemiBold"),url(/static/montserrat-latin-600.d5615136.woff2) format("woff2"),url(/static/montserrat-latin-600.f300da4f.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:600;src:local("Montserrat SemiBold italic"),local("Montserrat-SemiBolditalic"),url(/static/montserrat-latin-600italic.10f29d13.woff2) format("woff2"),url(/static/montserrat-latin-600italic.2bc37d86.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:700;src:local("Montserrat Bold "),local("Montserrat-Bold"),url(/static/montserrat-latin-700.7d77e1f0.woff2) format("woff2"),url(/static/montserrat-latin-700.81826529.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:700;src:local("Montserrat Bold italic"),local("Montserrat-Bolditalic"),url(/static/montserrat-latin-700italic.1dd2b53f.woff2) format("woff2"),url(/static/montserrat-latin-700italic.c162d257.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:800;src:local("Montserrat ExtraBold "),local("Montserrat-ExtraBold"),url(/static/montserrat-latin-800.d4e7bf86.woff2) format("woff2"),url(/static/montserrat-latin-800.895aadbf.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:800;src:local("Montserrat ExtraBold italic"),local("Montserrat-ExtraBolditalic"),url(/static/montserrat-latin-800italic.fc0cbe44.woff2) format("woff2"),url(/static/montserrat-latin-800italic.b3362875.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:900;src:local("Montserrat Black "),local("Montserrat-Black"),url(/static/montserrat-latin-900.c8bdd772.woff2) format("woff2"),url(/static/montserrat-latin-900.1b99ef78.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:900;src:local("Montserrat Black italic"),local("Montserrat-Blackitalic"),url(/static/montserrat-latin-900italic.cb72c1f9.woff2) format("woff2"),url(/static/montserrat-latin-900italic.b78bb9f8.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:300;src:local("Merriweather Light "),local("Merriweather-Light"),url(/static/merriweather-latin-300.f015f1e9.woff2) format("woff2"),url(/static/merriweather-latin-300.92dfe81b.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:300;src:local("Merriweather Light italic"),local("Merriweather-Lightitalic"),url(/static/merriweather-latin-300italic.7fd86b32.woff2) format("woff2"),url(/static/merriweather-latin-300italic.878b76f5.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:400;src:local("Merriweather Regular "),local("Merriweather-Regular"),url(/static/merriweather-latin-400.12dbf4c0.woff2) format("woff2"),url(/static/merriweather-latin-400.1fffad22.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:400;src:local("Merriweather Regular italic"),local("Merriweather-Regularitalic"),url(/static/merriweather-latin-400italic.1e0d3e81.woff2) format("woff2"),url(/static/merriweather-latin-400italic.de18d4c4.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:700;src:local("Merriweather Bold "),local("Merriweather-Bold"),url(/static/merriweather-latin-700.dc8fec81.woff2) format("woff2"),url(/static/merriweather-latin-700.d7d2ed8e.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:700;src:local("Merriweather Bold italic"),local("Merriweather-Bolditalic"),url(/static/merriweather-latin-700italic.b7b7e5da.woff2) format("woff2"),url(/static/merriweather-latin-700italic.6210a5fc.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:900;src:local("Merriweather Black "),local("Merriweather-Black"),url(/static/merriweather-latin-900.43f870d5.woff2) format("woff2"),url(/static/merriweather-latin-900.8f3806df.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:900;src:local("Merriweather Black italic"),local("Merriweather-Blackitalic"),url(/static/merriweather-latin-900italic.168c1ab2.woff2) format("woff2"),url(/static/merriweather-latin-900italic.ae7778f0.woff) format("woff")}</style></head><body><div id="___gatsby"><div style="max-width:42rem;margin-left:auto;margin-right:auto;padding:2.625rem 1.3125rem;" data-reactroot="" data-reactid="1" data-react-checksum="-2032749936"><h3 style="font-family:Montserrat, sans-serif;margin-top:0;margin-bottom:-1.75rem;" data-reactid="2"><a style="box-shadow:none;text-decoration:none;color:inherit;" href="/" data-reactid="3">nance.io</a></h3><div data-reactid="4"><!-- react-empty: 5 --><h1 data-reactid="6">A Better Story for Asp.Net Core Integration Testing</h1><p style="font-size:0.83255rem;line-height:1.75rem;display:block;margin-bottom:1.75rem;margin-top:-1.75rem;" data-reactid="7">July 05, 2018</p><div data-reactid="8"><h1>tl;dr</h1>
<p>I’ve built a library to improve the ergonomics and performance of your ASP.Net Core
integration tests. It allows you to write simple, elegant tests that run against an actual
database but don’t need to worry about side-effects. An example test might look like:</p>
<div class="gatsby-highlight">
      <pre class="language-csharp"><code class="language-csharp"><span class="token punctuation">[</span>Fact<span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">async</span> Task <span class="token function">Can_Get_All_Articles</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// arrange</span>
    <span class="token keyword">var</span> article <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Article</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> DbContext<span class="token punctuation">.</span>Articles<span class="token punctuation">.</span><span class="token function">AddAsync</span><span class="token punctuation">(</span>article<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> DbContext<span class="token punctuation">.</span><span class="token function">SaveChangesAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// act</span>
    <span class="token keyword">var</span> articles <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token generic-method function">GetAllAsync<span class="token punctuation">&lt;</span>Article<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token string">"articles"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// assert</span>
    Assert<span class="token punctuation">.</span><span class="token function">Single</span><span class="token punctuation">(</span>articles<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
      </div>
<p>The test runs inside a transaction that gets rolled back when the test completes.
This allows other tests to assume the database is empty.
Management of the <code class="language-text">DbContext</code> and <code class="language-text">TestServer</code> is handled for you by the library.</p>
<ul>
<li><a href="https://github.com/jaredcnance/DotnetTestAbstractions">Source Code</a></li>
<li><a href="https://www.nuget.org/packages/DotnetTestAbstractions">NuGet Package</a></li>
</ul>
<h1>Intro</h1>
<p><a href="https://nance.io/leveling-up-your-dotnet-testing-transactional-integration-testing-in-asp-net-core/">In my last post</a>
I showed an approach to using transactions in your ASP.Net Core integration tests.
This allows you to write tests that depend on database state, but do not require you to clean up the
database when you’re done.</p>
<p><em>I recommend reading <a href="(https://nance.io/leveling-up-your-dotnet-testing-transactional-integration-testing-in-asp-net-core/)">my previous post</a> for reasons you would use this approach instead of the in-memory database.</em></p>
<p>I included an example of a <code class="language-text">WebFixture</code> that sets up the <code class="language-text">TestServer</code>,
registers services and creates the <code class="language-text">IDbContextTransaction</code> for each test.
However, we found the performance of this approach became unbearable for a few
hundred tests after upgrading to dotnet core 2 (this included upgrading all the Microsoft.* packages).</p>
<p>I spent a few weeks trying to understand the problem and improve the performance of our tests after the upgrade.
In this post I outline my process and the solution that <strong>reduced test execution time by 93%</strong>.</p>
<h2>Investigating the Problem</h2>
<p>My first step was to profile the application and see what was consuming so much time.
I generally do all my work on my MBP, but there aren’t any good profilers that I’ve been able to find for OSX yet.
So, I booted up a <a href="https://developer.microsoft.com/en-us/windows/downloads/virtual-machines">Windows 10 development VM</a>
using VMWare and then used Visual Studio Community 2017 15.7.2 to start profiling the tests while they ran.</p>
<p>Unfortunately, my initial CPU sampling approach didn’t yield much for me to work on.
However, I did notice the test process memory continuing to grow unabated.</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/profile-1-96f44dd484a18e9eeae05152db767979-26ba6.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block; ; max-width: 590px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 49.20127795527157%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAACBElEQVQoz42SzW7TQBSF8668AM8AEkikNBS1TQupBDRNqFCFBOJvwYYNYglKaZrWdex44tjjv9jjsRMnPtwZCuoOrjSSx/fMp3PuTOPW7Xto7vZw//EhWnvH2D54jfbzN9h6eoLN/WNstF/iwU4fW50TtJ68Im2XtC9w9+EB7jQ76Dzbx9t3XXz41Mf7jz00HrV7KKUA9znCMITIMizKEmVRIJ3P4QURhMgxTxJac/oXIwy47mVZjp9DAzxM4Ew5RF6i0dw+RBJHMAwTlmXDnkzgujOEUYQ0zSCLUgMTgklZgPNQ7x2HkdbF4HSEi+F3OONzFGSk0SKHRZ7Btm0SOWCMISJYVVWo6xqq6nqN1Wqlv6WUWK/XBPbhzjgsgjrsDANjgFIBN3ePUFBk256AB4GG5XmuAQqqarFYaLECxXFMvTUCzjHzOEYmwzdjhi9DRv36N1CkCUzT1A4diqziZDTL5XKpgUII7Uztfd/XzpVD3w8wHLv4fGbh6wVDRSY0UIpUz0/F9TxPu1CulEt1uKALUvNTjgNKoZwqh2zq48epAZtxnF8ymNYMjY2dLg1pRcIQEYHUQQXLc3kds9aA6hq+XFY6snIbJSmuxoxGFYPxlIxk9Gz2+jrWzUv4V/3RyWIBczyhpxXjyi8wnQQ3gau/4v9ZqjIhMbq0MPViWO6cRhbiFzdy3x+Ml7UTAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="Profile results sorted by inclusive bytes"
        title=""
        src="/static/profile-1-96f44dd484a18e9eeae05152db767979-fb8a0.png"
        srcset="/static/profile-1-96f44dd484a18e9eeae05152db767979-1a291.png 148w,
/static/profile-1-96f44dd484a18e9eeae05152db767979-2bc4a.png 295w,
/static/profile-1-96f44dd484a18e9eeae05152db767979-fb8a0.png 590w,
/static/profile-1-96f44dd484a18e9eeae05152db767979-526de.png 885w,
/static/profile-1-96f44dd484a18e9eeae05152db767979-fa2eb.png 1180w,
/static/profile-1-96f44dd484a18e9eeae05152db767979-08f6a.png 1770w,
/static/profile-1-96f44dd484a18e9eeae05152db767979-26ba6.png 2504w"
        sizes="(max-width: 590px) 100vw, 590px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>What was happening was very similar to the issue described <a href="https://github.com/aspnet/EntityFrameworkCore/issues/10535">here</a>.
EntityFramework’s <code class="language-text">ServiceProviderCache</code> was continuing to grow, creating a new <code class="language-text">ServiceProvider</code> per test.</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/profile-2-a933a08d2951642cd1abe633c4242fd3-36c4a.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block; ; max-width: 590px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 54.91731940818103%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAABkUlEQVQoz5WSzUsbURTF3x8sSCmiC0txIe4shJoWiqJIEi36J7irFRQ3bXHhR8b5yMtkkswkmY+8mXlvTu+8ZCALIXHgxzn3Lu479zLs8OQrzn9+Q7NVx8Xldxz8qOPj5xo2dmpY397H1u4BUceHT1+wtrm3FPb3yUAS+gh8D8NBd6bDPvqeiySJ8d6PHV/9w+nvNlp3Do6uX9G442jc2jj6ZaBxY+Dsvosm0dK4S2EPzyaeDAteECLJgVGSwY+miLICJu+RFwhThYmQK8Hahgnu2EjiSEculESepdoP+h5kls2XKVaCPbdNODQwDGcD8zyHEAJFUcDzPKRpSh5QqoAqlsNeKKFtmYiitwdm84RlvQrs8cUGd3sYTyaQUtFASakynWg0HkNQwqq/FEk3vP/zCId74JzDdV34foAgGBEzFSLFlBKXiDmLtfbTuSdlls318W3bRqfTgWVZerDjOJpy5fIMpVaUddVb9EopMO4OIKlRJprQ2mNaMwxD7cu7xnFMP3hCr0+1Vr6qF72klf8DEvAwGp9KbsUAAAAASUVORK5CYII='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="ServiceProvider instances owned by the ServiceProviderCache"
        title=""
        src="/static/profile-2-a933a08d2951642cd1abe633c4242fd3-fb8a0.png"
        srcset="/static/profile-2-a933a08d2951642cd1abe633c4242fd3-1a291.png 148w,
/static/profile-2-a933a08d2951642cd1abe633c4242fd3-2bc4a.png 295w,
/static/profile-2-a933a08d2951642cd1abe633c4242fd3-fb8a0.png 590w,
/static/profile-2-a933a08d2951642cd1abe633c4242fd3-526de.png 885w,
/static/profile-2-a933a08d2951642cd1abe633c4242fd3-fa2eb.png 1180w,
/static/profile-2-a933a08d2951642cd1abe633c4242fd3-08f6a.png 1770w,
/static/profile-2-a933a08d2951642cd1abe633c4242fd3-36c4a.png 2298w"
        sizes="(max-width: 590px) 100vw, 590px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>Each <code class="language-text">ServiceProvider</code> gets added to the static <a href="https://github.com/aspnet/EntityFrameworkCore/blob/e300fdfe4ac314cc9e65520a15b9b7609a6c6a21/src/EFCore/Internal/ServiceProviderCache.cs#L21-L22"><code class="language-text">ServiceProviderCache._configurations</code></a>
which is persisted across test runs since they all run in the same process (AppDomains do not exist in .Net Core).
So, this <code class="language-text">ConcurrentDictionary</code> continued to grow:</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/profile-3-bbca9efff58870ac09624d413fcdb786-7615a.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block; ; max-width: 590px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 39.651162790697676%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABeklEQVQoz41SyW7bMBDV1/eWOE567Xf0kDRBkBgBei/QLG5cS6RIiqQkihS12H4ZEz3kUiQEHmbBzJuFk61FDSlKMM6R5zmKogBjLIGTr2AFlFJwrsNnXsaVRr7dwhgLrU0i1VqjrmuUpUgFOC/Rtg4hBHjvCeG/yHzXpQ6MMSmhI9sn6dE6lzqTUqWCIfQIfZ/kMfkY/95OhNbSyKYBtxHcRFTtgGmaMRKmf5h3+2T3cYCjQiFEDMNEZJEKExERDuOEGEci1AqP61dsWQkhBEGiUhK6UgmWxldSorEW0xDR1haxDxhJd00D71qwIqcYgXkckH37KXD6Y42z6xcsrteEPzi5fEr6ydULvnz/ja+3G5zf5Vjcl7h4qLBYKSzvGS5WHMsHjdObDRbEsVwJZN24h7Adnv8yPL7m+PW8QaEsVOOTX7sIWTuwqoHuBtgwoY47lNbRilzSVRuQSwPjaeTjVx92cxonBtqPP57H4eP7OOyB/e6dOae8N13RWM//8s3LAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="ServiceProviderCache Static Member Referencing ServiceProviders"
        title=""
        src="/static/profile-3-bbca9efff58870ac09624d413fcdb786-fb8a0.png"
        srcset="/static/profile-3-bbca9efff58870ac09624d413fcdb786-1a291.png 148w,
/static/profile-3-bbca9efff58870ac09624d413fcdb786-2bc4a.png 295w,
/static/profile-3-bbca9efff58870ac09624d413fcdb786-fb8a0.png 590w,
/static/profile-3-bbca9efff58870ac09624d413fcdb786-526de.png 885w,
/static/profile-3-bbca9efff58870ac09624d413fcdb786-fa2eb.png 1180w,
/static/profile-3-bbca9efff58870ac09624d413fcdb786-7615a.png 1720w"
        sizes="(max-width: 590px) 100vw, 590px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>According to <a href="https://github.com/aspnet/EntityFrameworkCore/issues/12440#issuecomment-399158858">ajvickers</a>:</p>
<blockquote>
<p>When AddDbContext is called it ensures certain services used by EF are added to the service provider.
For example, ILoggerFactory. Since this is done for every context instance, it’s equivalent to what is described in #10211.
Registering the context as a singleton is generally not a good idea even in tests since it should never be registered as singleton in any real app.
Assuming that you want to keep it this way, probably the best way to tackle this is to take over management of the internal service provider in your tests.
This will stop EF from building and caching the internal service provider for you.</p>
</blockquote>
<p>Okay, so that helps a lot and I now have a much better understanding of what’s going on.
From this response I gathered a few things:</p>
<ol>
<li>We don’t want to call <code class="language-text">AdDbContext</code> multiple times in the same process for the same <code class="language-text">DbContext</code> implementation.</li>
<li>Registering the <code class="language-text">DbContext</code> as a singleton is not ideal.</li>
<li>There will be performance consequences if we try to hijack EF’s internal service provider.</li>
</ol>
<h2>Caching Test Servers</h2>
<p>So, the very first problem was our fixture was creating a new <code class="language-text">TestServer</code> instance
and calling <code class="language-text">AddDbContext</code> for every test. Based on the information discovered above,
this is a bad idea.</p>
<p>Depending on what version of EF Core you’re running, you may even get a nice build warning that
points out the issue:</p>
<div class="gatsby-highlight">
      <pre class="language-text"><code class="language-text">warn: Microsoft.EntityFrameworkCore.Infrastructure[10402]
More than twenty &#39;IServiceProvider&#39; instances have been created for internal use by Entity Framework.
This is commonly caused by injection of a new singleton service instance into every DbContext instance.
For example, calling UseLoggerFactory passing in a new instance each time--see https://go.microsoft.com/fwlink/?linkid=869049 for more details.
Consider reviewing calls on &#39;DbContextOptionsBuilder&#39; that may require new service providers to be built.</code></pre>
      </div>
<p>So, the first and most obvious step was to cache our <code class="language-text">TestServer</code> instances.
We wouldn’t restart our production web app after each request, so why should we do it in our tests?
The implementation is pretty straightforward, so I’ll direct you over to the GitHub repo so you can see it yourself.
I define a <a href="https://github.com/jaredcnance/DotnetTestAbstractions/blob/27851f18f83c234512e492ca5122fcf5b4d54035/src/DotnetTestAbstractions/Fixtures/TestServerCache.cs#L10"><code class="language-text">TestServerCache</code></a>
that creates and configures the server and then the fixture <a href="https://github.com/jaredcnance/DotnetTestAbstractions/blob/27851f18f83c234512e492ca5122fcf5b4d54035/src/DotnetTestAbstractions/Fixtures/TestServerFixture.cs#L43">can just fetch it from the cache</a>.</p>
<h2>Sharing Ambient Scope</h2>
<p>Now that we’re re-using <code class="language-text">TestServer</code> instances, we still need a way to share <code class="language-text">DbContext</code> instances.
And since our previous approach relied on a singleton DI registration, this would mean that every single test would get the same <code class="language-text">DbContext</code> instance which isn’t what we want.
The reason we couldn’t register it as a scoped service is because the scope is created and disposed during the lifetime of the request.
We need access to the scope before and after the request.</p>
<p>Instead, we have two options:</p>
<ol>
<li>Share the database connection</li>
<li>Share the DI request scope</li>
</ol>
<p>Option 1 would require changing application code to support tests.
It is also a very minimal solution that supports a single use case.
Option 2 would allow us to inspect the state of any scoped service the same way the application code would.
In order to maximize the number of covered use cases and not be required to change application code, I decided to go with #2.</p>
<p>There is an <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.iservicescopefactory?view=aspnetcore-2.1"><code class="language-text">IServiceScopeFactory</code></a>
interface we can implement to define our our scope for dependency injection. Whenever a service attempts to access the <code class="language-text">RequestServices</code>, the <code class="language-text">RequestServicesFeature</code>
<a href="https://github.com/aspnet/Hosting/blob/a8c0970cde72242c40534c6c56a99f1d2ee6827a/src/Microsoft.AspNetCore.Hosting/Internal/RequestServicesFeature.cs#L29-L39">ensures that an <code class="language-text">IServiceScope</code> exists</a>
by calling <code class="language-text">IServiceScopeFactory.CreateScope()</code>. Since this was written against an injected interface, we can override the implementation and inject our own <code class="language-text">IServiceScopeFactory</code>.
This would let us create the scope outside of the web request and return the existing scope when the middleware tries to create it.</p>
<p>There are a few requirements of this approach that should be mentioned:</p>
<ul>
<li>Our test should create an “ambient scope” that is available to the test and also to the web request.</li>
<li>The <code class="language-text">IServiceScopeFactory</code> has to be added to the application container.</li>
<li>Multiple tests should not share an <code class="language-text">IServiceScope</code>.</li>
<li>When the middleware tries to dispose the scope, it should be a no-op. This allows us to continue using the scope after the request has ended.</li>
</ul>
<p>In order to satisfy these requirements, I decided to store the scopes in an
<a href="https://msdn.microsoft.com/en-us/library/dn906268(v=vs.110).aspx"><code class="language-text">AsyncLocal</code></a> member on the factory.
From the docs:</p>
<blockquote>
<p><strong>AsyncLocal<T> Class</strong>
Represents ambient data that is local to a given asynchronous control flow, such as an asynchronous method.</p>
</blockquote>
<p>An example implementation might look like:</p>
<div class="gatsby-highlight">
      <pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AsyncLocalServiceScopeFactory</span> <span class="token punctuation">:</span> IServiceScopeFactory
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> AsyncLocal<span class="token operator">&lt;</span>IServiceScope<span class="token operator">></span> _asyncLocalScope <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncLocal</span><span class="token operator">&lt;</span>IServiceScope<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> IServiceScope <span class="token function">CreateScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>_asyncLocalScope<span class="token punctuation">.</span>Value <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token operator">?</span> _asyncLocalScope<span class="token punctuation">.</span>Value
            <span class="token punctuation">:</span> <span class="token function">CreateAmbientScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> IServiceScope <span class="token function">CreateAmbientScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// what now...?</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
      </div>
<p>This would allow us to create the scope ourselves, outside of the web request:</p>
<div class="gatsby-highlight">
      <pre class="language-csharp"><code class="language-csharp"><span class="token keyword">var</span> scope <span class="token operator">=</span> AsyncLocalServiceScopeFactory<span class="token punctuation">.</span><span class="token function">CreateAmbientScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
      </div>
<p>However, we still need to prevent the ASP.Net middleware from disposing our scope.
We can do this by making <code class="language-text">IDisposable.Dipose()</code> a no-op and exposing an <code class="language-text">ActuallyDispose()</code>
method to the test.</p>
<div class="gatsby-highlight">
      <pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServiceScope</span> <span class="token punctuation">:</span> IServiceScope
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> IServiceProvider ServiceProvider <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* Do nothing 😬 */</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ActuallyDispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* Dispose of our scope */</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
      </div>
<h3>Okay, but where does the service lifecycle management take place?</h3>
<p>So far we haven’t actually resolved any services from this scope and we haven’t wired it
up to an actual container so it’s pretty much useless right now.
Component/service lifecycle management is not something that I really wanted to roll myself and the
existing types in Microsoft.Extensions.DependencyInjection seem pretty limited.</p>
<p>So, I turned to <a href="https://github.com/autofac/Autofac">Autofac</a> — a very mature IoC container solution
that provides full support for scopes and nested scopes (something I’ll dive into shortly).</p>
<p>Using Autofac, our <code class="language-text">AsyncLocalServiceScopeFactory</code> class becomes:</p>
<div class="gatsby-highlight">
      <pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AsyncLocalServiceScopeFactory</span> <span class="token punctuation">:</span> IServiceScopeFactory
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> AsyncLocal<span class="token operator">&lt;</span>ServiceScope<span class="token operator">></span> _asyncLocalScope <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncLocal</span><span class="token operator">&lt;</span>ServiceScope<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> IContainer _container<span class="token punctuation">;</span>

    <span class="token keyword">public</span> IServiceScope <span class="token function">CreateScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* unchanged */</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> IServiceScope <span class="token function">CreateAmbientScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">var</span> lifetimeScope <span class="token operator">=</span> _container<span class="token punctuation">.</span><span class="token function">BeginLifetimeScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> scope <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceScope</span><span class="token punctuation">(</span>lifetimeScope<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _asyncLocalScope<span class="token punctuation">.</span>Value <span class="token operator">=</span> scope<span class="token punctuation">;</span>
        <span class="token keyword">return</span> scope<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
      </div>
<p>I’ve also passed the Autofac <code class="language-text">ILifetimeScope</code> to the <code class="language-text">ServiceScope</code> implementation which will
resolve services from the scope itself.
It will also dispose the scope when our test calls <code class="language-text">ActuallyDispose</code>:</p>
<div class="gatsby-highlight">
      <pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServiceScope</span> <span class="token punctuation">:</span> IServiceScope<span class="token punctuation">,</span> IServiceProvider
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> ILifetimeScope _lifetimeScope<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">ServiceScope</span><span class="token punctuation">(</span>ILifetimeScope lifetimeScope<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _lifetimeScope <span class="token operator">=</span> lifetimeScope<span class="token punctuation">;</span>
        ServiceProvider <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> IServiceProvider ServiceProvider <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">object</span> <span class="token function">GetService</span><span class="token punctuation">(</span>Type serviceType<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> _lifetimeScope<span class="token punctuation">.</span><span class="token function">Resolve</span><span class="token punctuation">(</span>serviceType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* Do nothing 😬 */</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ActuallyDispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> _lifetimeScope<span class="token punctuation">.</span><span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
      </div>
<p>At this point the test and the web request share the exact same scope.
This is definitely a step in the right direction and should handle most cases.
However, there are a few cases where this falls short.
For example, the Asp.Net Core Identity <code class="language-text">UserStore</code> <a href="https://github.com/aspnet/Identity/issues/1068">caches entities in the scope</a>.
This would prevent the following test from passing:</p>
<div class="gatsby-highlight">
      <pre class="language-csharp"><code class="language-csharp">user<span class="token punctuation">.</span>Password <span class="token operator">=</span> <span class="token string">"myNewPassword"</span><span class="token punctuation">;</span>
<span class="token comment">// send a request to update the user's password</span>
<span class="token keyword">await</span> <span class="token function">PatchUserAsync</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// send a request to login</span>
<span class="token keyword">await</span> <span class="token function">PostLoginAsync</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
      </div>
<p>The reason this fails is because we are deviating a bit from the way ASP.Net Core request scopes should be handled by the application.
In order to better approximate the behavior of an actual web app,
we should give each web request its own scope but still provide access to services registered against the ambient scope.
The below illustration shows the different possibilities.</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/request-scope-illustrations-6f736aedd3940799e499127e6bcbc41f-ec9c6.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block; ; max-width: 590px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 142.85714285714286%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAdCAYAAACqhkzFAAAACXBIWXMAAAsSAAALEgHS3X78AAAFD0lEQVRIx3VVaXfaRhT1//8dXU7b5LhtHG9xYhtcNkloX9CCJCSEEJLYwY6d3D4NDsVx+uGeN4yYO2/m3fvmaLNZoML2OTKsK8xfYL2aYbWc7rGu8DxXxW84KrIhikmCLEtQjUsal/kIRZ5iWuxQFmNaWO4WVeQHGxySMUJON8BZHppWH0Kvj67dR9sOwNkhJDeAE4bomSpGyYAynaFIA0wn8YuMXxCaxRbWAujNvsCcfSXgGV+gTZ+QbJ6QjiIijLCcjlGMfORDD4tpxjJ9RaiM5lCyDdTJhuIayngNebSGmm1h5iv05/cI4wGRDmjBFHnSRzke7IleEUrpEu87Gt61ZBbft1S8ueHw5x2PuhnAWz4hGkYYE+H9donVotwv/uEdWuMZPsgeTonsUrRx2XVwJbu0gQIuKtGbf4UVjZClEVPCi0r/KEN/MoU+fYRePEDPH3eoxuw3oXyCFY8xGccvCP83w2FeYDhfwyk3jMDId0RGUY3vqTCPUOKMMoyZHpeL1xkeEh/FUR9J7MMP+/CCPlzfg913YXsOegTDdWC6NhEVeLhfsSzvtzvhHx7/G+nROB2SJGK69Bij4YDIQ4oRi3HoIx74SKIQQ6p0hWS4k1Al/P1RD4R+xNHlf7xo4vTdNc5ObnF13tjFiwa4Jom+ZYInCG2LQeRs9ltTNNzfLzErRkzo+wwVquy74xv89ssJ/j7+iJO/rvH293M2Fto2XCtDT08IIwaboEkDKJLOjp76OkHDvKwynuNI7pqQeI8W9yC0dugSuAbNcw50KYQmBhQDNjbVGEo3gCSolOGCWbESe3XHLMOK0JBj8BR1J4DZ86CYHjTyt2CSv00fSo/IaN5yXNrcJELyeVdjGa6+v0NFtKAIPlRawEcZ2v0UTQIf5RCTKbphCjlM4C0+I16uIQo6/T+ELO6O/L2MGKFaHUGz8LbG4Y9rDj+f13FcF3B8J+CiLaFFG5jlA8IZ+Vw0GaEiGbsMv2mwImWEUkXoQzQcstoEEkEZJOAoM96LoEQp2e8ztHwDq1xDov9r4gCqbO4JV8sDpwjkYZn30WmrkFUbkmiw4/B0NLGro8NpaDRlNOl7s6OiRVISOx4RGj8mDPrkEKeCB6dnw7HIIWYVbdgE167gwO09g8YOzVUNd7uZv3ZK1eMWVPKqxS+pNS3mBZPAfJ5jRk10NptgXmE+oW/5f99nBft/pb0XVTY0A+fvazg9uaZ4i8uzOi5Ob3H7qYPmHRWE0G4o6DRUdJoajXUIHQt16pmVZdfLAmUW/Zdhz3TRrGv4RJa7OvsHn8iGZ+SWRk2BbaQwFHJFl+6MoQ+NYNIc37KYt8vUx8hTMMsTlumRqfdIrA541YXsDCH1qLLuCJZL4uV1tKhobZrvOjFkL4boRFD7EWXYpgyH9LZQ842oG9F17B4pIuRbBlSSxx0RtYIMt0RqlFuqOlmRKn2t+bhSfFxKtPFwgf7iEbWbFnUlarrVs3DwJBChTf41YJD23tzy+Om8hg+SCyXfglccdIXde/PrxzZqXgZx8kAv5GfUah2kSfyi0rs3hQQtUDtykgx6toQ6nCBYPcFeA13dJ8/qMJICMgm+l05hpjNCiRvafDxK9oT7DC06cuuOHqQ2jy4vQ+Cosk0etaaIO7Jesy5RgQQCj8Zth6FZpxeRLJqlyf6d2Qs7n4yoWiEG1J19z2UIfBcDQhh4iKhjR4PgIAaIowo+0+T3j9W/MPA7jgIgSU0AAAAASUVORK5CYII='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="Iterations of the design"
        title=""
        src="/static/request-scope-illustrations-6f736aedd3940799e499127e6bcbc41f-fb8a0.png"
        srcset="/static/request-scope-illustrations-6f736aedd3940799e499127e6bcbc41f-1a291.png 148w,
/static/request-scope-illustrations-6f736aedd3940799e499127e6bcbc41f-2bc4a.png 295w,
/static/request-scope-illustrations-6f736aedd3940799e499127e6bcbc41f-fb8a0.png 590w,
/static/request-scope-illustrations-6f736aedd3940799e499127e6bcbc41f-ec9c6.png 707w"
        sizes="(max-width: 590px) 100vw, 590px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>We have currently implemented scenario 1 and I am in the process of finishing support for scenarios 1-2.</p>
<h2>So, Where’s The Abstraction?</h2>
<p>I would love to see this officially supported by Microsoft.
But until then, I have provided a library you can use so you don’t need to worry about the details.</p>
<ul>
<li><a href="https://github.com/jaredcnance/DotnetTestAbstractions">Source Code</a></li>
<li><a href="https://www.nuget.org/packages/DotnetTestAbstractions">NuGet Package</a></li>
</ul>
<p>If you have any questions or are interested in supporting this project, feel free to reach out to me
on Twitter <a href="https://twitter.com/jaredcnance">@jaredcnance</a>.</p></div><hr style="margin-bottom:1.75rem;" data-reactid="9"/><div style="display:flex;margin-bottom:4.375rem;" data-reactid="10"><img src="/static/profile-pic.7c56beb9.png" alt="jaredcnance" style="margin-right:0.875rem;margin-bottom:0;margin-top:1.575rem;width:8.75rem;height:8.75rem;border-radius:50%;" data-reactid="11"/><!-- react-text: 12 --> <!-- /react-text --><p data-reactid="13"><!-- react-text: 14 -->My name is <!-- /react-text --><strong data-reactid="15"> Jared Nance </strong><!-- react-text: 16 -->, I live and work in Kansas City.I enjoy building things and sharing what I learn along the way.<!-- /react-text --><!-- react-text: 17 --> <!-- /react-text --><!-- react-text: 18 -->You can follow me on<!-- /react-text --><!-- react-text: 19 --> <!-- /react-text --><a href="https://twitter.com/jaredcnance" data-reactid="20"> Twitter </a><!-- react-text: 21 --> or<!-- /react-text --><!-- react-text: 22 --> <!-- /react-text --><a href="https://github.com/jaredcnance" data-reactid="23"> GitHub </a><!-- react-text: 24 --> <!-- /react-text --></p><!-- react-text: 25 --> <!-- /react-text --></div><ul style="display:flex;flex-wrap:wrap;justify-content:space-between;list-style:none;padding:0;" data-reactid="26"><li data-reactid="27"><a rel="prev" href="/leveling-up-your-dotnet-testing-transactional-integration-testing-in-asp-net-core/" data-reactid="28"><!-- react-text: 29 -->← <!-- /react-text --><!-- react-text: 30 -->Leveling Up Your .Net Testing Patterns - Part II Transactional Integration Testing<!-- /react-text --></a></li></ul><div style="position:fixed;bottom:50px;right:30px;cursor:pointer;transition-duration:0.2s;transition-timing-function:linear;transition-delay:0s;opacity:0;visibility:hidden;transition-property:opacity, visibility;" data-reactid="31"><div class="css-1rl7lfj" data-reactid="32">△</div></div></div><span style="display:block;clear:both;" data-reactid="33"> </span></div></div><script id="webpack-manifest">/*<![CDATA[*/window.webpackManifest={"231608221292675":"app-65f6eef773a4d1949159.js","99219681209289":"component---node-modules-gatsby-plugin-offline-app-shell-js-5c4c5a0f7af9dc69d6d7.js","107818501498521":"component---src-templates-blog-post-js-84198a550b368f49f5e5.js","162898551421021":"component---src-pages-404-js-4503918ea3a16cfcdb75.js","35783957827783":"component---src-pages-index-js-37d2a82a5015888d9ec3.js","60335399758886":"path----557518bd178906f8d58a.js","210333531512890":"path---offline-plugin-app-shell-fallback-a0e39f21c11f6a62c5ab.js","172750132438648":"path---a-better-story-for-asp-net-core-integration-testing-686a0b3d463a2424c4b4.js","70179299880030":"path---leveling-up-your-dotnet-testing-transactional-integration-testing-in-asp-net-core-bfaeee4c2f69251542aa.js","163616910017581":"path---leveling-up-your-dotnet-testing-327c5a78ae046bfd7421.js","130323105709194":"path---dotnet-performance-optimization-815dda98c5b44a663c33.js","106575918426696":"path---logging-in-azure-functions-60b1df906f5c1c431e56.js","68384136547871":"path---dotnet-core-dependency-injection-57709773b4c081d4b60d.js","180578961852115":"path---typescript-vs-javascript-e3979dccbdd9363699eb.js","47572940128521":"path---hangfire-tasks-in-dotnet-core-499b654f768ca73494d8.js","254022195166212":"path---404-a0e39f21c11f6a62c5ab.js","142629428675168":"path---index-73785e339d6ceaeb88f4.js","178698757827068":"path---404-html-a0e39f21c11f6a62c5ab.js","114276838955818":"component---src-layouts-index-js-c56dd00f07d25fed4a16.js"}/*]]>*/</script><script>
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-116668380-1', 'auto');
      }
      </script><script>/*<![CDATA[*/!function(e,t,r){function n(){for(;d[0]&&"loaded"==d[0][f];)c=d.shift(),c[o]=!i.parentNode.insertBefore(c,i)}for(var s,a,c,d=[],i=e.scripts[0],o="onreadystatechange",f="readyState";s=r.shift();)a=e.createElement(t),"async"in i?(a.async=!1,e.head.appendChild(a)):i[f]?(d.push(a),a[o]=n):e.write("<"+t+' src="'+s+'" defer></'+t+">"),a.src=s}(document,"script",["/commons-052854b14b2d9cebb713.js","/app-65f6eef773a4d1949159.js","/path---a-better-story-for-asp-net-core-integration-testing-686a0b3d463a2424c4b4.js","/component---src-templates-blog-post-js-84198a550b368f49f5e5.js","/component---src-layouts-index-js-c56dd00f07d25fed4a16.js"])/*]]>*/</script></body></html>