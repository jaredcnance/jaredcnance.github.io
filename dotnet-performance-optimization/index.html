<!DOCTYPE html><html><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><link rel="preload" href="/component---src-layouts-index-js-c56dd00f07d25fed4a16.js" as="script"/><link rel="preload" href="/component---src-templates-blog-post-js-086e07739fc65e01f8db.js" as="script"/><link rel="preload" href="/path---dotnet-performance-optimization-815dda98c5b44a663c33.js" as="script"/><link rel="preload" href="/app-a5e665fcdbad95c1eeb3.js" as="script"/><link rel="preload" href="/commons-052854b14b2d9cebb713.js" as="script"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><title data-react-helmet="true">A Strategy for the Measurement and Optimization of .NET Application Performance | nance.io</title><meta data-react-helmet="true" property="og:title" content="A Strategy for the Measurement and Optimization of .NET Application Performance | nance.io"/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" property="og:image" content="/static/fallback.9c01bf00.jpg"/><meta data-react-helmet="true" property="og:description"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:site" content="@jaredcnance"/><meta data-react-helmet="true" name="twitter:title" content="A Strategy for the Measurement and Optimization of .NET Application Performance | nance.io"/><meta data-react-helmet="true" name="twitter:description" content="null"/><meta data-react-helmet="true" name="twitter:image" content="/static/fallback.9c01bf00.jpg"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:100%/1.75 'Merriweather','Georgia',serif;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.9);font-family:'Merriweather','Georgia',serif;font-weight:400;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:Montserrat,sans-serif;font-weight:900;text-rendering:optimizeLegibility;font-size:2.5rem;line-height:1.1;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.73286rem;line-height:1.1;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.4427rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;letter-spacing:0.140625em;text-transform:uppercase;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.83255rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.75966rem;line-height:1.1;font-style:italic;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}ul{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;list-style:disc;}ol{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}p{margin-left:0;margin-right:0;margin-top:1.2rem;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.2rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:0.85rem;line-height:1.75rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1rem;line-height:1.75rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}blockquote{margin-left:-1.75rem;margin-right:1.75rem;margin-top:0;padding-bottom:0;padding-left:1.42188rem;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1.20112rem;line-height:1.75rem;color:hsla(0,0%,0%,0.59);font-style:italic;border-left:0.32813rem solid hsla(0,0%,0%,0.9);}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.75rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}b{font-weight:700;}strong{font-weight:700;}dt{font-weight:700;}th{font-weight:700;}li{margin-bottom:calc(1.75rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}li > ul{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(1.75rem / 2);}code{font-size:0.85rem;line-height:1.75rem;}kbd{font-size:0.85rem;line-height:1.75rem;}samp{font-size:0.85rem;line-height:1.75rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.16667rem;padding-right:1.16667rem;padding-top:0.875rem;padding-bottom:calc(0.875rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}blockquote > :last-child{margin-bottom:0;}blockquote cite{font-size:1rem;line-height:1.75rem;color:hsla(0,0%,0%,0.9);font-weight:400;}blockquote cite:before{content:"— ";}ul,ol{margin-left:0;}@media only screen and (max-width:480px){ul,ol{margin-left:1.75rem;}blockquote{margin-left:-1.3125rem;margin-right:0;padding-left:0.98438rem;}}h1,h2,h3,h4,h5,h6{margin-top:3.5rem;}a{box-shadow:0 1px 0 0 currentColor;color:#007acc;text-decoration:none;}a:hover,a:active{box-shadow:none;}mark,ins{background:#007acc;color:white;padding:0.10938rem 0.21875rem;text-decoration:none;}a.gatsby-resp-image-link{box-shadow:none;}</style><style id="gatsby-inlined-css">code[class*=language-],pre[class*=language-]{color:#bfc7d5;background:none;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;background:#292d3e}:not(pre)>code[class*=language-]{color:#292d3e;background-color:rgba(191,199,213,.53333);padding:.1em .3em;border-radius:.3em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#697098}.token.class-name,.token.punctuation{color:#82aaff}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#ff5572}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#ffcb6b}.token.constant,.token.property,.token.symbol{color:#c3e88d}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#bf79db}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#c3e88d}.token.entity,.token.operator,.token.url{color:#80cbc4}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:#66d9ef}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:100;src:local("Montserrat Thin "),local("Montserrat-Thin"),url(/static/montserrat-latin-100.50d27986.woff2) format("woff2"),url(/static/montserrat-latin-100.5e334eff.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:100;src:local("Montserrat Thin italic"),local("Montserrat-Thinitalic"),url(/static/montserrat-latin-100italic.8c070533.woff2) format("woff2"),url(/static/montserrat-latin-100italic.03e19243.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:200;src:local("Montserrat Extra Light "),local("Montserrat-Extra Light"),url(/static/montserrat-latin-200.4343d3d9.woff2) format("woff2"),url(/static/montserrat-latin-200.f2022ecd.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:200;src:local("Montserrat Extra Light italic"),local("Montserrat-Extra Lightitalic"),url(/static/montserrat-latin-200italic.116c4c4b.woff2) format("woff2"),url(/static/montserrat-latin-200italic.89614a60.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:300;src:local("Montserrat Light "),local("Montserrat-Light"),url(/static/montserrat-latin-300.d2ad295b.woff2) format("woff2"),url(/static/montserrat-latin-300.3a371ee0.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:300;src:local("Montserrat Light italic"),local("Montserrat-Lightitalic"),url(/static/montserrat-latin-300italic.f6b6bf24.woff2) format("woff2"),url(/static/montserrat-latin-300italic.16521668.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:400;src:local("Montserrat Regular "),local("Montserrat-Regular"),url(/static/montserrat-latin-400.240a8444.woff2) format("woff2"),url(/static/montserrat-latin-400.b20cc131.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:400;src:local("Montserrat Regular italic"),local("Montserrat-Regularitalic"),url(/static/montserrat-latin-400italic.86172bb8.woff2) format("woff2"),url(/static/montserrat-latin-400italic.9405e787.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:500;src:local("Montserrat Medium "),local("Montserrat-Medium"),url(/static/montserrat-latin-500.fb8d6b71.woff2) format("woff2"),url(/static/montserrat-latin-500.50825d47.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:500;src:local("Montserrat Medium italic"),local("Montserrat-Mediumitalic"),url(/static/montserrat-latin-500italic.c0a555a4.woff2) format("woff2"),url(/static/montserrat-latin-500italic.635de59c.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:600;src:local("Montserrat SemiBold "),local("Montserrat-SemiBold"),url(/static/montserrat-latin-600.d5615136.woff2) format("woff2"),url(/static/montserrat-latin-600.f300da4f.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:600;src:local("Montserrat SemiBold italic"),local("Montserrat-SemiBolditalic"),url(/static/montserrat-latin-600italic.10f29d13.woff2) format("woff2"),url(/static/montserrat-latin-600italic.2bc37d86.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:700;src:local("Montserrat Bold "),local("Montserrat-Bold"),url(/static/montserrat-latin-700.7d77e1f0.woff2) format("woff2"),url(/static/montserrat-latin-700.81826529.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:700;src:local("Montserrat Bold italic"),local("Montserrat-Bolditalic"),url(/static/montserrat-latin-700italic.1dd2b53f.woff2) format("woff2"),url(/static/montserrat-latin-700italic.c162d257.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:800;src:local("Montserrat ExtraBold "),local("Montserrat-ExtraBold"),url(/static/montserrat-latin-800.d4e7bf86.woff2) format("woff2"),url(/static/montserrat-latin-800.895aadbf.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:800;src:local("Montserrat ExtraBold italic"),local("Montserrat-ExtraBolditalic"),url(/static/montserrat-latin-800italic.fc0cbe44.woff2) format("woff2"),url(/static/montserrat-latin-800italic.b3362875.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:900;src:local("Montserrat Black "),local("Montserrat-Black"),url(/static/montserrat-latin-900.c8bdd772.woff2) format("woff2"),url(/static/montserrat-latin-900.1b99ef78.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:900;src:local("Montserrat Black italic"),local("Montserrat-Blackitalic"),url(/static/montserrat-latin-900italic.cb72c1f9.woff2) format("woff2"),url(/static/montserrat-latin-900italic.b78bb9f8.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:300;src:local("Merriweather Light "),local("Merriweather-Light"),url(/static/merriweather-latin-300.f015f1e9.woff2) format("woff2"),url(/static/merriweather-latin-300.92dfe81b.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:300;src:local("Merriweather Light italic"),local("Merriweather-Lightitalic"),url(/static/merriweather-latin-300italic.7fd86b32.woff2) format("woff2"),url(/static/merriweather-latin-300italic.878b76f5.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:400;src:local("Merriweather Regular "),local("Merriweather-Regular"),url(/static/merriweather-latin-400.12dbf4c0.woff2) format("woff2"),url(/static/merriweather-latin-400.1fffad22.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:400;src:local("Merriweather Regular italic"),local("Merriweather-Regularitalic"),url(/static/merriweather-latin-400italic.1e0d3e81.woff2) format("woff2"),url(/static/merriweather-latin-400italic.de18d4c4.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:700;src:local("Merriweather Bold "),local("Merriweather-Bold"),url(/static/merriweather-latin-700.dc8fec81.woff2) format("woff2"),url(/static/merriweather-latin-700.d7d2ed8e.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:700;src:local("Merriweather Bold italic"),local("Merriweather-Bolditalic"),url(/static/merriweather-latin-700italic.b7b7e5da.woff2) format("woff2"),url(/static/merriweather-latin-700italic.6210a5fc.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:900;src:local("Merriweather Black "),local("Merriweather-Black"),url(/static/merriweather-latin-900.43f870d5.woff2) format("woff2"),url(/static/merriweather-latin-900.8f3806df.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:900;src:local("Merriweather Black italic"),local("Merriweather-Blackitalic"),url(/static/merriweather-latin-900italic.168c1ab2.woff2) format("woff2"),url(/static/merriweather-latin-900italic.ae7778f0.woff) format("woff")}</style></head><body><div id="___gatsby"><div style="max-width:42rem;margin-left:auto;margin-right:auto;padding:2.625rem 1.3125rem;" data-reactroot="" data-reactid="1" data-react-checksum="-235229710"><h3 style="font-family:Montserrat, sans-serif;margin-top:0;margin-bottom:-1.75rem;" data-reactid="2"><a style="box-shadow:none;text-decoration:none;color:inherit;" href="/" data-reactid="3">nance.io</a></h3><div data-reactid="4"><!-- react-empty: 5 --><h1 data-reactid="6">A Strategy for the Measurement and Optimization of .NET Application Performance</h1><p style="font-size:0.83255rem;line-height:1.75rem;display:block;margin-bottom:1.75rem;margin-top:-1.75rem;" data-reactid="7">January 12, 2018</p><div data-reactid="8"><blockquote>
<p>This is a cross-post from <a href="https://stackify.com/net-application-optimization">stackify.com</a></p>
</blockquote>
<h2>Introduction</h2>
<p>It’s Friday afternoon, the majority of the development staff has already packed up and headed home for the weekend, but you remain to see the latest hotfix through to production. To your dismay, immediately after deployment, queues start backing up and you begin to get alerts from your monitoring system. Something has been broken and all evidence points to an application performance bottleneck.</p>
<p>This experience is all too common for developers and software team managers. What can we do to prevent poor performing code from reaching our production environment and bringing our “guaranteed 0% downtime” platform to its knees under the load of production volume? The answer lies in proper pre-production processes that validate our changes have not had substantial negative performance impacts.</p>
<p>In this article, I propose a workflow for measuring performance, diagnosing potential issues, and validating the efficacy of improvements. It’s an iterative process of discovery, profiling, refactoring, testing, benchmarking, and monitoring.</p>
<p>The sample application used in this article can be found on GitHub.</p>
<h2>Code Reviews</h2>
<p>Performing code reviews is an essential part of maintaining some quality control over code before it reaches production. Code reviews allow your team members to read through your changes and, using their best judgment, approve or suggest changes to your work. This also helps the entire team keep abreast of all changes that are important to them.</p>
<p>However, code reviews take up time of other engineers and can sometimes be less thorough than desired. The thoroughness of a review is rarely communicated to the team and so an approval can provide a false sense of security that the code is indeed production-ready.</p>
<p>Another failure point is that code reviews rarely include any kind of quantitative feedback. In other words, I can suggest method A will be faster or allocate less than method B, but I am unlikely to take the time to prove the quantitative impact of my assertion.</p>
<p>Finally, things simply get missed. Changes can be made in isolation from the consuming code and a reviewer may not be aware of the context in which a particular set of changes is being executed. For example, adding a simple one-time string concatenation may be fine, but if the consuming code is iterating over the changed code millions of times, then we may have just introduced some significant performance bottleneck.</p>
<p>In summary, code review is an indispensable part of the development process. It aids in maintaining style consistency, knowledge transfer, developer education and overall quality control. But, it should not be viewed as a method for ensuring that the implementation does not have any adverse or out-of-bounds performance impact.</p>
<h2>The Application</h2>
<p>The example application used in this blog post can be found on GitHub. It is a simple .NET Core web API application. The focus of this post is on the /people?name={name} route. This request will search our database of People and perform a fuzzy string match on the name, returning the entire list sorted from most to least similar. For the sake of simplicity, we will only implement one matching algorithm: Levenshtein Distance.</p>
<p>I recommend taking a quick look at the GitHub project. The call stack we’ll be focused on looks like:</p>
<p><a href="https://github.com/jaredcnance/FuzzySearch/blob/e01fd327ea988889b8878a5dbbd699e1c617a4ee/API/Domain/People/PeopleController.cs#L17-L21">PeopleController.GetAsync</a>
<br />
└── <a href="https://github.com/jaredcnance/FuzzySearch/blob/e01fd327ea988889b8878a5dbbd699e1c617a4ee/API/Domain/People/PersonService.cs#L31-L37">PersonService.SearchAsync</a>
<br />
　 　 └── Enumerable.OrderBy
<br />
　　　 　 └── <a href="https://github.com/jaredcnance/FuzzySearch/blob/e01fd327ea988889b8878a5dbbd699e1c617a4ee/API/Services/FuzzyComparer.cs#L20-L35">FuzzyComparer.Compare</a>
<br />
　　　　　 　 └── <a href="https://github.com/jaredcnance/FuzzySearch/blob/e01fd327ea988889b8878a5dbbd699e1c617a4ee/API/Services/LevenshteinFuzzySearch.cs#L16">LevenshteinFuzzySearch.ComputeSimilarity</a></p>
<h2>Discovery</h2>
<p>Application Performance Management (APM) tools, such as Prefix and Retrace, can be used to identify poorly performing applications at a high level. This investigation enables local discovery of performance issues, and helps us narrow our focus before using a more detailed profiling utility.</p>
<h3>Local Development Environment</h3>
<p>In this example, I will use Prefix (a free tool from Stackify) to evaluate the distribution of work. This will help me understand what operations contribute the most to overall response time in the request. Perform these steps to get started.</p>
<ol>
<li>Install Prefix on Windows</li>
<li>Launch Prefix in your browser by clicking the tray icon</li>
<li>Start the application</li>
<li>Send a request with the search filter applied</li>
</ol>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/prefix-1-ee0b0123bf7bc68f1f091a08d3af3cae-9160a.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block; ; max-width: 590px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAARlAAAEZQAGA43XUAAABFklEQVQY0yXPSVeDMBQFYP6JWq1HQNoCLXMoFFrC1CLKUBd6rDv///76CIvv3DDk5kWKuz+E5Sf8bCA9WD6KnAR8gJO+Y8NqGPuLsA5qbIIKu7ihLLGJO1jHDvvsDDdpIDHeUcmAsBjBSFhcxVoor6JQdgq82DkUt4DFe2ypbCo0owvMsCI13GyEvEshHZpvZN0vso8bcsoJ72/0/ANO75LLF5W2sJOWJizgVxWt32DF5DBp56QD9KCApLkZtukAg05RdwlUK4VqH6FQTlfaRmdoLqdrl9D8CrJV0iQnypOYaJbQ//Me6VHzsNQjPK0Z7hSbOLhXXWGxYnimb6bhwWEcK3aG7FVY2sSpsdAPeNB8EsxePfwDVDmuPlNDUNYAAAAASUVORK5CYII='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="prefix 1"
        title=""
        src="/static/prefix-1-ee0b0123bf7bc68f1f091a08d3af3cae-fb8a0.png"
        srcset="/static/prefix-1-ee0b0123bf7bc68f1f091a08d3af3cae-1a291.png 148w,
/static/prefix-1-ee0b0123bf7bc68f1f091a08d3af3cae-2bc4a.png 295w,
/static/prefix-1-ee0b0123bf7bc68f1f091a08d3af3cae-fb8a0.png 590w,
/static/prefix-1-ee0b0123bf7bc68f1f091a08d3af3cae-526de.png 885w,
/static/prefix-1-ee0b0123bf7bc68f1f091a08d3af3cae-9160a.png 1024w"
        sizes="(max-width: 590px) 100vw, 590px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>As you can see from the above screenshot, the majority of the work is consumed by our .NET application code while a minor portion is consumed by I/O. From this I can quickly tell that this particular request has a risk of running as slow as 2.2 seconds on the first request and around 900 ms for subsequent requests. This is beyond the threshold of perceived user control. According to <a href="https://www.nngroup.com/articles/powers-of-10-time-scales-in-ux/">Jakob Nielson</a>:</p>
<blockquote>
<p>new pages must display within 1 second for users to feel like they’re navigating freely</p>
</blockquote>
<p>And it is significantly beyond the 0.1 second threshold of perceived instantaneity.</p>
<h3>Staging Environment</h3>
<p>Prefix is a great tool for uncovering errors or performance issues in your local dev environment, but it can be difficult or impractical to reproduce production scenarios locally. Tools like Retrace are excellent at providing these same kind of insights in remotely deployed environments. Retrace will not only help detect production issues, but can also be used to discover issues in a staging environment so that bugs and performance problems are discovered early in the release cycle. Through log management, application monitoring, metrics and alerts you can quickly improve the quality of your release process. Retrace’s <a href="http://stackify.com/deployment-tracking/">deployment tracking</a> features also enable you to identify performance issues caused by recent changes to application code.</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/retrace-1-d4b0428c188c7c15bf03bfbbf142cada-53a6b.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block; ; max-width: 590px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 60.105448154657296%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAAChElEQVQoz01SS2tTQRS+Ozf+AH+AiGvRKvjA4sq9L6iPIoq1RYu0FMTHRrAiiHXRVNF9ERcqShvbtMm9SYs2adKkNzRpjfRh0uTeedx53WeS6xhceOabb5iP8505cEYZuD/Q3Tty9ubIiZ67J3oGz1wfOX1t6Nilgf9x9GL/4XO3jpzv67pwu7t3+NTVezLz5OVBxSLMtYXRqFcqFQCh7dhCLtt2/oUUHMYZhJAS4sroiL7nYoSUqoGLlWpps24iYgIIAMQWNxFvQNoABGCOiUB/2ZaiAWjNpCbmuyYFmCibVfA+vjy1WMDVXVyr+cINm2EraLtOIA2OHcirJzzf8V3hurZPGtCX1QHRMgWFcB7T16dzpWgyHUsXPmZWoytrqv4zoa+r+kYsX/qaWZ3K6NFsca5QjuXLs8v6l/j3nV1jMVtQLMeJLGgRNfFuIfVmMfkiGY8k5t9qiYgWj6hqZH5uXI1LnpAsoakTKe2VplZMc2mlqDSDIAzbodyttm1RT3BGmcssSlGTCg9bnkUDZLmM+Qw1XS9stsKgaTuelskrCJHpH/q39Np2tfG7jg1s1wA3sdiqW+VtU7KBhAEFpoJxmzJBhMOEQwjXllaUKuDJ1Y10adPEFHMXECEBqQ2ZU4cMELthcdfzc7/ITB6miii5tDOTM+cKKJrKKVugJntutVp+0PT9QA6YUkYoleBcMCbHA2TCjQ+f9zwYPfDk+f7Hj/Y9fbb34ejYp1nFqu0Erbbrep3wHcel0sG5dHfMDCIQtsLx6eErYwf7It39r7uGJo7feXlocmpS4diE8hNwLp2yhHyZdcwWIfKUXSCEvSDg2zUzqzfy6yi/ZmTL9XQJ1s0/yzpSypE3txsAAAAASUVORK5CYII='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="retrace 1"
        title=""
        src="/static/retrace-1-d4b0428c188c7c15bf03bfbbf142cada-fb8a0.png"
        srcset="/static/retrace-1-d4b0428c188c7c15bf03bfbbf142cada-1a291.png 148w,
/static/retrace-1-d4b0428c188c7c15bf03bfbbf142cada-2bc4a.png 295w,
/static/retrace-1-d4b0428c188c7c15bf03bfbbf142cada-fb8a0.png 590w,
/static/retrace-1-d4b0428c188c7c15bf03bfbbf142cada-526de.png 885w,
/static/retrace-1-d4b0428c188c7c15bf03bfbbf142cada-53a6b.png 1138w"
        sizes="(max-width: 590px) 100vw, 590px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>Here is an example of what it looks like in Retrace’s performance view (the red arrows are pointing to the deployment markers).</p>
<h3>Profiling</h3>
<p>Now that we’ve identified—at a high level—an execution code path of interest, we can dive a little deeper by using a profiler. There are several different profiling options, most of which are personal preference. Visual Studio comes with a Performance Profiler, but there are alternatives such as JetBrains dotTrace and dotMemory. I should mention that the only profiler I was able to get to consistently work with .NET Core was Visual Studio Performance Profiler while debugging. In addition to the debugging profiler, Visual Studio comes with several <a href="https://docs.microsoft.com/en-us/visualstudio/profiling/profiling-feature-tour">other options</a>, most of which do not yet work with .NET Core. For a quick overview of the Visual Studio Profiler, I will defer to <a href="https://docs.microsoft.com/en-us/visualstudio/profiling/beginners-guide-to-performance-profiling#BKMK_External_Code">the official documentation</a>.</p>
<p>Your approach to profiling should probably depend on the application type. For long-running applications with a constant and stable workload, you can sometimes get quick behavioral insights from just the CPU and memory charts. Before I dive into profiling the sample application, I’ll cover two common scenarios you may encounter while profiling.</p>
<h4>Memory leaks</h4>
<p>The first example shows an app that executes a job every few seconds. You can see the memory being consumed by our application is continuing to grow and doesn’t appear to have any correlation to CPU usage. In this particular case, we’re seeing a memory leak where each unit of work in the application is leaking references and so they are not being cleaned up.</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/memory-leak-0f3fc71a4e7029e89406e21a65c2d150-95632.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block; ; max-width: 576px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 41.14583333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABlklEQVQoz2XRW2sTQRjG8f0k1e3u7GF2NwnsprupqbV7SjUIgcYkDYnYC+udgodaBam1tQZBERH1yq/6d3ZTqDYXP+adZ3jnwGjtdkyWZRR5RpYX9HoFRbmL50kavsSXLrZlkXVbRBsJ0eY26VaHeCNiMy1J2hFldpskjhHCRgsaTRK12JAmrmXS8kxu3tDxbIM4CgjDBjJoEoQxdwp1aL/P3eGI/mRKOj6gNzvk8PiIe5MZnvTQ1vV1HF9t2hvQvT9ie29OOXvC7sFTBs/eMzz6xP67r0xPvrF/8p3p6Y/a7OwXDy9+Mz//yXzxh3z6GH1tDc3QdbLBSDV9YfL2M+NLdX28YPT6ggevPirnSy/PasPKiw/sPT9l/GZBMX6EMAy0JOmQFyW3ulvs7KSkWU6a5sQqdxyJq56xyr/GQ3o+vqI1my0qQlhYlo1jO7WqrjIhBMK8ps6ty1pgGma9aRhG6slqYpqWIjCMiskyWzZW46rV3FI/XPVpVdHuhDjSwVY3s50rjusq/8yd/9ev2PhBgHQlfwEQmBAa2s4BXQAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="memory leak"
        title=""
        src="/static/memory-leak-0f3fc71a4e7029e89406e21a65c2d150-95632.png"
        srcset="/static/memory-leak-0f3fc71a4e7029e89406e21a65c2d150-9d04d.png 148w,
/static/memory-leak-0f3fc71a4e7029e89406e21a65c2d150-f1dcb.png 295w,
/static/memory-leak-0f3fc71a4e7029e89406e21a65c2d150-95632.png 576w"
        sizes="(max-width: 576px) 100vw, 576px"
      />
    </span>
  </span>
  
  </a>
    </p>
<h4>Overworked services</h4>
<p>The next example shows an unbound and unthrottled event processing application. In other words, it processes real-time events as they occur. We can see that while memory is increasing, so is CPU. This may be an indication that the application is just doing too much work, possibly in parallel. We may need to implement some kind of throttling. That could be an out-of-process mechanism—such as limiting the number of unacknowledged messages that should be delivered to a queue (in the case of AMQP). Or it could be an in-process mechanism—such as using a Semaphore. Or maybe we just need to scale our services to handle the load. But without diving in, there’s not much else we can infer from the graphs.</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/overworked-service-bffeffc327e2fd44a003353eafc300ff-56a1e.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block; ; max-width: 578px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 42.214532871972324%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAAB3UlEQVQoz2WRWU8TYRSG+z+8EDr70mmnzNhV7HQotGJj6WZaQTQ2EmPiQsGqkbgAKlGMMdFbfoA/8vF0asKFF0/Od863nO99T8rPr1CrRdTjmHitQS2KaDZbuK6LYZiYpmAYRJUcfj4gW6qzWikTBgGlqEExDKmWikluyLmU63qs5POoy0voShpD09EFTdXQdAPDtDBtFzuTI5MP8YsVivUm5fU21c0e0daY9fGE6PYQL+ORUhUVJxdQH94nHk3Y2H3CzckL2o9ndJ4e0Zt+ZPjqjNHRd8bvfnD3/c+E7eNf7Jz8Tnjw9YJbe1PSS8ukNFXl+kabsVwYvf3Gnddn8sCXf3xmOPvE4OUpg8NT+ocn9A+OL5FmvekHBnKmubOHIYpSQXiNRmOdcrkiPq6Jh+KlxEqlmsi1bOd/nMtoWoJpJ3nGE8meJ2b7PvOf6rKh214yBF26aZq28FKiquooaVXQRJqa1ObRdi0yOYdcMJ9FKJJlAKq6uKhoJmndYe6romiL+nxf1pZjYWctvMAlGhaSmisPdffrPPvTpbNf4+oV8dCSX3lelowvElyHbMEnqGYJV31q3QI3tgo0tsu0HlYZvInpHkTcO29S6xfoPI/YPW/x6GKT3izGMh3+Akx2GE5rNSSzAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="overworked service"
        title=""
        src="/static/overworked-service-bffeffc327e2fd44a003353eafc300ff-56a1e.png"
        srcset="/static/overworked-service-bffeffc327e2fd44a003353eafc300ff-8869e.png 148w,
/static/overworked-service-bffeffc327e2fd44a003353eafc300ff-87a4d.png 295w,
/static/overworked-service-bffeffc327e2fd44a003353eafc300ff-56a1e.png 578w"
        sizes="(max-width: 578px) 100vw, 578px"
      />
    </span>
  </span>
  
  </a>
    </p>
<h3>Sample application results</h3>
<p>In our example application, there’s not much we can learn from the graphs themselves. However, since we’ve already identified a particular route of interest, we can set breakpoints to record memory and CPU usage around areas of interest. For this application, I set breakpoints in the service layer to capture the resource consumption of our search service.</p>
<p>Below are the results from profiling the sample application. We can quickly see that we’re spending most of our CPU time in our fuzzy comparison function. This should not surprise us. Looking a little bit deeper we can see that 30% of the time spent within this function is spent in <code class="language-text">System.String.Substring(/*...*/)</code>.</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/profiler-1-29558d2dcf98c3c1fe827c2a106025a5-9160a.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block; ; max-width: 590px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 32.51953125%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAARlAAAEZQAGA43XUAAABLElEQVQoz5WRS07DMBCGcw8a8rJj5+XGeTgJaVqBVBCX4AScBLFAIO7QrhHn+xkbKth0weLTP5rFN+OxZ8wAy7JsMY4Tuq5H/9MzxmAYRii1hpQZOE8djEhS4ZBFCZHliKkXpyk83XRoW4Nx2kDrDlVVo6b87veo65YGzTDDhEa3UDTgoWrxnmo8iwavssULr/EUlXij9KzAUpZrnGqlGhI1KGi6lDmEyBw51VFZ4THT+PRLHIMKx1WOw0WGA+WHX8D7KzqJ1bpBTrIkTsAY/yVh7mkbkt5Lib0QuI5i7IIQW+KW8zNCZbernOR0N4eV0t1GGnYjBZaUYwwuMYWByx1j54T6rDChnOmT7ooCWxLMJLNcBQH2mfy/0G445AUm30e/WmGgtBhiDkN8AVEs2Rf+MWTuAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="profiler 1"
        title=""
        src="/static/profiler-1-29558d2dcf98c3c1fe827c2a106025a5-fb8a0.png"
        srcset="/static/profiler-1-29558d2dcf98c3c1fe827c2a106025a5-1a291.png 148w,
/static/profiler-1-29558d2dcf98c3c1fe827c2a106025a5-2bc4a.png 295w,
/static/profiler-1-29558d2dcf98c3c1fe827c2a106025a5-fb8a0.png 590w,
/static/profiler-1-29558d2dcf98c3c1fe827c2a106025a5-526de.png 885w,
/static/profiler-1-29558d2dcf98c3c1fe827c2a106025a5-9160a.png 1024w"
        sizes="(max-width: 590px) 100vw, 590px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/profiler-2-b0bf6ba4e8210f5f30b6fdc4a8db1920-dd3ab.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block; ; max-width: 590px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 29.018338727076593%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAABXElEQVQY0yVQy07DMBDMB8CRCoEQTdw2DydN87Cdpnk1bblwggMSIA4t4vUVCC6VaKH0iwfbHEar3Z2d8dhwX/awH7/hPu9gP/3Afdrh9GGDzv0GR7drHF69w1puEbzt0bn5xMH1B8hqi8HyC/7rL3qr/93x3VrvDOZ7SMJAg0dDiHika8kTsNCHdXaCOKAYswQO6cKxzuU+1PwsjZHKymRPBwREco1L1wMvaxRFhWbaop3NkRcl4oTBowG6JkEUp5gvLnSv0ExnmEjObL5A3bTIJwWCYQiL9GE4jqOb0SgCFwIiy5CNcwTBEN2uCdO0YNsOxnKmaq/XB2MccSwTMIYkSSHknbpXXMOVL4yiWA8o9TU8j+pjRVBwHFcmKHVVgkJkEFxgkhfaKE1TKB3LIjB8P9BDhbKsMJURMnmgnJWREqSUYi7jKaOBbaOq1BcVaGX0um7AOdeChPTwByhxxZh7gkvWAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="profiler 2"
        title=""
        src="/static/profiler-2-b0bf6ba4e8210f5f30b6fdc4a8db1920-fb8a0.png"
        srcset="/static/profiler-2-b0bf6ba4e8210f5f30b6fdc4a8db1920-1a291.png 148w,
/static/profiler-2-b0bf6ba4e8210f5f30b6fdc4a8db1920-2bc4a.png 295w,
/static/profiler-2-b0bf6ba4e8210f5f30b6fdc4a8db1920-fb8a0.png 590w,
/static/profiler-2-b0bf6ba4e8210f5f30b6fdc4a8db1920-526de.png 885w,
/static/profiler-2-b0bf6ba4e8210f5f30b6fdc4a8db1920-dd3ab.png 927w"
        sizes="(max-width: 590px) 100vw, 590px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>Historically, this wouldn’t have been our first choice for optimization. However, since the introduction of System.Span in C# 7.2, we now have a tool for improving some of these string parsing operations. Now that we have a candidate for optimization, the next step is to write benchmarks against the current implementation so that we can accurately quantify our improvements.</p>
<h2>Benchmarking</h2>
<p>Benchmarking is a critical step when making performance improvements. Without it, we have no way to validate the impact of our changes.</p>
<h3>Writing benchmarks</h3>
<p>I don’t think there is any argument that the best tool for writing benchmarks for .NET today is <a href="https://github.com/dotnet/BenchmarkDotNet">BenchmarkDotNet</a>. Lots of people are using this tool today including <a href="https://github.com/aspnet/Mvc/blob/bfb5f23647f440e4b83045efe0afc3a234195bdb/benchmarks/Microsoft.AspNetCore.Mvc.Performance/Microsoft.AspNetCore.Mvc.Performance.csproj#L15">the AspNetCore team</a>.</p>
<p>I like to approach benchmarking in a very similar fashion to unit testing. For every project in the solution, I will create a corresponding benchmark project. The benchmark project will mirror the organization of the classes in the project under test. Each benchmark gets prefixed with the name of the system under test (e.g. Foo_Benchmarks.cs). This makes them easier to find later and distinguishable when locating types by name.</p>
<h3>Running benchmarks</h3>
<p>A benchmark application is just a console app that calls the benchmark runner. There are two approaches you can use in this entrypoint. The first is by explicitly listing the benchmarks you’d like to run:</p>
<div class="gatsby-highlight">
      <pre class="language-csharp"><code class="language-csharp"><span class="token keyword">class</span> <span class="token class-name">Program</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        BenchmarkRunner<span class="token punctuation">.</span><span class="token generic-method function">Run<span class="token punctuation">&lt;</span>Foo_Benchmarks<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        BenchmarkRunner<span class="token punctuation">.</span><span class="token generic-method function">Run<span class="token punctuation">&lt;</span>Bar_Benchmarks<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
      </div>
<p>The second is a command line switcher that will provide you a prompt to specify the benchmark you’d like to run, assuming one was not provided as an argument. This is particularly useful if your project has a lot of benchmarks since running benchmarks can consume a great deal of time.</p>
<div class="gatsby-highlight">
      <pre class="language-csharp"><code class="language-csharp"><span class="token keyword">class</span> <span class="token class-name">Program</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> switcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BenchmarkSwitcher</span><span class="token punctuation">(</span><span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
            <span class="token keyword">typeof</span><span class="token punctuation">(</span>Foo_Benchmarks<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">typeof</span><span class="token punctuation">(</span>Bar_Benchmarks<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        switcher<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
      </div>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/benchmarks-1-7d4893e14a119387491903daefb9a359-3c2f0.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block; ; max-width: 590px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 19.37901498929336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsSAAALEgHS3X78AAAAdUlEQVQY05WQSRaAIAxDcx7nCcR5uP+dKrH6ZOFCF3kNfTT9ANhF0O0Ct2mtJ0E5aM17QWQEsf0uFH64XVUMt/SbBqZOA/8ISSuvCsl4Dn163eFCKpw7qUhnFiWsRkEzP1/AnrnJvRpPXvQaxNfRZ97n3dk7AIbbcFXnP523AAAAAElFTkSuQmCC'); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="benchmarks 1"
        title=""
        src="/static/benchmarks-1-7d4893e14a119387491903daefb9a359-fb8a0.png"
        srcset="/static/benchmarks-1-7d4893e14a119387491903daefb9a359-1a291.png 148w,
/static/benchmarks-1-7d4893e14a119387491903daefb9a359-2bc4a.png 295w,
/static/benchmarks-1-7d4893e14a119387491903daefb9a359-fb8a0.png 590w,
/static/benchmarks-1-7d4893e14a119387491903daefb9a359-526de.png 885w,
/static/benchmarks-1-7d4893e14a119387491903daefb9a359-3c2f0.png 934w"
        sizes="(max-width: 590px) 100vw, 590px"
      />
    </span>
  </span>
  
  </a>
    </p>
<h4>Using diagnosers</h4>
<p><a href="http://benchmarkdotnet.org/Configs/Diagnosers.htm">Diagnosers</a> are one example of customizations you can use to improve your benchmarks. They can be attached to your benchmarks by decorating benchmark classes with attributes. My personal favorite is the <code class="language-text">MemoryDiagnoser</code>, which provides cross-platform allocation and garbage collection detail.</p>
<h4>Using test data</h4>
<p>The setup, teardown and parameter specification for benchmarks has a pretty similar interface to NUnit. You can create Global and Iterative <a href="http://benchmarkdotnet.org/Advanced/SetupAndCleanup.htm">Setup/Cleanup methods</a>.
You can also define compile-time constant parameters as members of the benchmark class or as an enumerable <a href="http://benchmarkdotnet.org/Advanced/Params.htm#example-paramssource">ParamsSource</a>. For non compile-time constants, you will need to implement the IParam interface, which I have done <a href="https://github.com/jaredcnance/FuzzySearch/blob/e01fd327ea988889b8878a5dbbd699e1c617a4ee/Benchmarks/Services/FuzzySearch_Benchmarks.cs#L43-L54">in the example</a>.</p>
<p>There are many more features in BenchmarkDotNet and I highly recommend reading through their <a href="http://benchmarkdotnet.org/">documentation</a>.</p>
<h4>Example output</h4>
<p>The example benchmark uses non compile-time constant parameters to create some random string data to be passed into our distance function. In the example, I generate random strings of lengths 10, 100, 1000, and 10000, and compare each of them against a randomly-generated string of length 100. You can take a look at the generated Markdown results here.</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/benchmarks-2-4536674c748d499867c9ae44ee1547aa-9160a.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block; ; max-width: 590px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 21.2890625%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAARlAAAEZQAGA43XUAAAAtUlEQVQY04WMSxKCMBBEoyiKxVf0ECqSTCKKRPB3/zO1k7BwZbl49TI90xEbq7DuCNlFI28JxXUk5TluDFbGIFQnzOUJC/akaiD2Z4jDD+JGc2kkJIOIHWntvWQvOBO75sv+D9OqRVBfESiLoLpgpjpPcGwxJ85q3rvM3UhHN87S3dnR0vq3+0PkdEepn0hpQEEPbM0bBc8uK80LK3lDqgZP4sz3MbukJxLuRKpHRD1y7ma8+wBlxXKDDczuzwAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="benchmarks 2"
        title=""
        src="/static/benchmarks-2-4536674c748d499867c9ae44ee1547aa-fb8a0.png"
        srcset="/static/benchmarks-2-4536674c748d499867c9ae44ee1547aa-1a291.png 148w,
/static/benchmarks-2-4536674c748d499867c9ae44ee1547aa-2bc4a.png 295w,
/static/benchmarks-2-4536674c748d499867c9ae44ee1547aa-fb8a0.png 590w,
/static/benchmarks-2-4536674c748d499867c9ae44ee1547aa-526de.png 885w,
/static/benchmarks-2-4536674c748d499867c9ae44ee1547aa-9160a.png 1024w"
        sizes="(max-width: 590px) 100vw, 590px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>The first observation I would make is that the function’s execution time and allocations are linearly proportional to the size of the query parameter we are provided. What this means is that we have inadvertently created an attack vector for a bad actor. By not truncating the query string value, clients could invoke our API with long query strings in rapid succession. Based on the data, this would likely cause large CPU and memory spikes, potentially degrading our service or forcing us to scale.</p>
<p>The next observation is the memory allocation. In the case of a 1k character string, we will allocate over 6.6 MB just for comparing strings and 66 MB if we get a 10k character string!</p>
<h2>Fixing the Problem</h2>
<p>Now that we understand the problem, we can implement a solution and validate the improvement with refactoring, unit tests, and benchmarking.</p>
<h3>The process</h3>
<p>Before we start making optimizations, we need to make sure that we have unit tests around the system we intend to affect. Without tests, we may improve performance but we also risk breaking existing functionality. So the iterative process for making performance improvements should look like:</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/process-1-9d38b0806d9cb700d0979aa6b7f4576b-e08ca.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block; ; max-width: 590px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 42.43902439024391%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABkElEQVQoz5WSW2/TQBCF/f//BZVCadLEVQKNS2kiqyC1QohCuEgENxdTt3USJ47v14/dNZV44IWRzu7O7syZM7urFUVBkiSkaUpZFmRZJuZS7ZXirKoqhTiOkbFZlitfxkhIS4uEOAvVWnPsJc8ODmgdHnKi9+j2ulyMxpjjEf3BgKura1qtFnpP582ZwVGng36i0+8PMIYGvh+w3Fp8tK9xgwe0NE/IRVWJJ3V5nqtqUlEYRkRR1KgTXUjl0peKJZTaqmQdPrL0btFu1z+Uk1WpSA7YbDxF6Ps+u91OJWd/CvzbajVGouWlN0Nbhy6f7Pe4kcO3yYQX7TamafL55obn4hqO20eMzUuVJNU/3enfkBakfkOoAqtCyU6KuKlZ1fyvxXnUENZ1k1wI0p/ud35t56RVzGK+YDabqban0ymWZeG6LrZt49w5rFYrtXd//6DEPO4d5hurIWxIa7xoxeTuA/tsy9fJF4anL3n39lK0bNI97jASr28YZ5yfv+bV8FT8Cl2sL9gGHgvPYp/4/AZHp1MtHJCK6wAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="process 1"
        title=""
        src="/static/process-1-9d38b0806d9cb700d0979aa6b7f4576b-fb8a0.png"
        srcset="/static/process-1-9d38b0806d9cb700d0979aa6b7f4576b-1a291.png 148w,
/static/process-1-9d38b0806d9cb700d0979aa6b7f4576b-2bc4a.png 295w,
/static/process-1-9d38b0806d9cb700d0979aa6b7f4576b-fb8a0.png 590w,
/static/process-1-9d38b0806d9cb700d0979aa6b7f4576b-e08ca.png 615w"
        sizes="(max-width: 590px) 100vw, 590px"
      />
    </span>
  </span>
  
  </a>
    </p>
<h3>The solution</h3>
<p>In our example application, I’m going to replace
<a href="https://github.com/jaredcnance/FuzzySearch/blob/c91eb96671854502e1150c65e80586c30d9c3856/API/Services/LevenshteinFuzzySearch.cs#L48">the use of string.Substring</a>
with <a href="https://github.com/jaredcnance/FuzzySearch/blob/e01fd327ea988889b8878a5dbbd699e1c617a4ee/API/Services/LevenshteinFuzzySearch.cs#L48-L51">the new <code class="language-text">Span&lt;T&gt;</code></a>
introduced in C# 7.2. For a great introductory on this new type, check out <a href="https://channel9.msdn.com/Events/Connect/2017/T125">Jared Parson’s video on Channel 9</a>.
For a more in-depth look at Span and how you can use it today,
check out <a href="http://adamsitnik.com/Span/#how-to-use-it-today">this post by Adam Sitnik</a>.</p>
<p><code class="language-text">Span&lt;T&gt;</code> allows us to work with contiguous memory in a type safe way. In the case of string parsing, this means we can iterate over the characters of a string and use an indexer to access characters without allocating a new string – string.Substring allocates new strings everytime.</p>
<p>I recommend taking a look <a href="https://github.com/jaredcnance/FuzzySearch/commit/e01fd327ea988889b8878a5dbbd699e1c617a4ee">at the commit</a> to see the updated implementation using <code class="language-text">Span</code> instead of <code class="language-text">.Substring</code>. The significant change was from this:</p>
<div class="gatsby-highlight">
      <pre class="language-csharp"><code class="language-csharp"><span class="token keyword">var</span> a <span class="token operator">=</span> str2<span class="token punctuation">.</span><span class="token function">Substring</span><span class="token punctuation">(</span>j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> b <span class="token operator">=</span> str1<span class="token punctuation">.</span><span class="token function">Substring</span><span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> cost <span class="token operator">=</span> <span class="token punctuation">(</span>a <span class="token operator">==</span> b <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
      </div>
<p>To this:</p>
<div class="gatsby-highlight">
      <pre class="language-csharp"><code class="language-csharp"><span class="token keyword">var</span> a <span class="token operator">=</span> str2<span class="token punctuation">.</span><span class="token function">AsSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Slice</span><span class="token punctuation">(</span>j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> b <span class="token operator">=</span> str1<span class="token punctuation">.</span><span class="token function">AsSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Slice</span><span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> cost <span class="token operator">=</span> <span class="token punctuation">(</span>a <span class="token operator">==</span> b <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
      </div>
<h3>Benchmark results</h3>
<p>In order to evaluate the efficacy of our changes, we need to re-run our benchmarks against the new implementations, comparing them against the old. To do this, we can temporarily expose the old methods and tell BenchmarkDotNet that it should be our baseline for comparison:</p>
<div class="gatsby-highlight">
      <pre class="language-csharp"><code class="language-csharp"><span class="token punctuation">[</span>Benchmark<span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">LevenshteinDistance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">=</span><span class="token operator">></span> _levenshteinFuzzySearch<span class="token punctuation">.</span><span class="token function">ComputeSimilarity</span><span class="token punctuation">(</span>String1<span class="token punctuation">.</span>Value<span class="token punctuation">,</span> String2<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span><span class="token function">Benchmark</span><span class="token punctuation">(</span>Baseline <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">LevenshteinDistanceBaseline</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">=</span><span class="token operator">></span> _levenshteinFuzzySearch<span class="token punctuation">.</span><span class="token function">ComputeSimilarity_Baseline</span><span class="token punctuation">(</span>String1<span class="token punctuation">.</span>Value<span class="token punctuation">,</span> String2<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
      </div>
<p>Now, running our benchmarks against the new and improved code gives us the following results:</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/benchmarks-3-d67778a610d7eea5e85879405457b2e3-9160a.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block; ; max-width: 590px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 26.953125%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAARlAAAEZQAGA43XUAAAAxklEQVQY042O1xKCMBBFASmjNOtPKCXBhOCg6Kj//0vXzWJ7cnw4c8tsNutkskUsNQKhEEmFUIwEtYJfaUK9cXaaaH+z7AXyTiJrCWNpWBPdYNrs4RWaF7l22fYPJvaK0l5o4NeGrwqlQVCNHf9adHALM1KSrw/UPX356b2K+qjskYkzcnlBKgYsSOdE/tUlzImxOaqP7HlOnlkz0lQOcGbiiJW6YU0kVGz0nfKVs9WYHr6GU1Lrp7xwQN5c4IseE2JGczY/AEtwj1hN9E60AAAAAElFTkSuQmCC'); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="benchmarks 3"
        title=""
        src="/static/benchmarks-3-d67778a610d7eea5e85879405457b2e3-fb8a0.png"
        srcset="/static/benchmarks-3-d67778a610d7eea5e85879405457b2e3-1a291.png 148w,
/static/benchmarks-3-d67778a610d7eea5e85879405457b2e3-2bc4a.png 295w,
/static/benchmarks-3-d67778a610d7eea5e85879405457b2e3-fb8a0.png 590w,
/static/benchmarks-3-d67778a610d7eea5e85879405457b2e3-526de.png 885w,
/static/benchmarks-3-d67778a610d7eea5e85879405457b2e3-9160a.png 1024w"
        sizes="(max-width: 590px) 100vw, 590px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>This shows that across the board, execution time decreased approximately 77% and allocations decreased by 94%. So, what does that mean in terms of user response time? Well, let’s take another look at our application in Prefix.</p>
<h3>Prefix and Profiler results</h3>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/prefix-2-9b144da31f8c0649b3a999749753c179-9160a.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block; ; max-width: 590px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 28.515625%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAARlAAAEZQAGA43XUAAABP0lEQVQY03WQWU/CUBBG+1NEURNlLVoF2tsWlS63axBaBAIoMer/fz/e1iXxwYeTbzKZOZOM5sRrRl6B6S0Q4ZKxStMv6qy4cjL6ImFgp+iKnhWji5hrV/VNSX+ywHiY43gxlj9HM8OSu3SDiFZU9Wz1gRU9Mc23ZMUrl2PJxa3k/HpK184wpqU6ktbCKq/smIGI1O6qPqjJbMN6/UY62xKrert5R+Zrsscd8+KFG7VoTHJ6SjxwAgw3+RI5ybdUoXJgJ+hWhBbLFfJ+hi8knh1xb0l8NewpMm9OaIZK9CXpipzWOKI9DGpat94f+rVw8UycL/GC5Jv0N2ePJcORS7Pn0FX/qiSXNwEnhqRphDQ6gkZrTKNtcqTyuGOhhYcP/P2Bu+WSSflDiVuUhPsd7SCoB890l1N9ouSCk+7/fAJZBNaA5MVKogAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="prefix 2"
        title=""
        src="/static/prefix-2-9b144da31f8c0649b3a999749753c179-fb8a0.png"
        srcset="/static/prefix-2-9b144da31f8c0649b3a999749753c179-1a291.png 148w,
/static/prefix-2-9b144da31f8c0649b3a999749753c179-2bc4a.png 295w,
/static/prefix-2-9b144da31f8c0649b3a999749753c179-fb8a0.png 590w,
/static/prefix-2-9b144da31f8c0649b3a999749753c179-526de.png 885w,
/static/prefix-2-9b144da31f8c0649b3a999749753c179-9160a.png 1024w"
        sizes="(max-width: 590px) 100vw, 590px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>Here you can see both implementations running against the same dataset. We can see a slight improvement over the initial request, but what’s interesting is the 318 ms response time for subsequent requests. We’re now much closer to Nielson’s 0.1s target for perceived instantaneity on a fuzzy search across 5000 records.</p>
<p>If we take a look at the profiler output for the new implementation, we can see how the breakdown has changed.</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/profiler-3-edc6feaba303de1b51fa7a80b876a922-9160a.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block; ; max-width: 590px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 32.421875%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAARlAAAEZQAGA43XUAAABE0lEQVQY02WQS07DMBRFuxGS0MZ2fnY+dpK2KZAygIoJO2A9LAAJJqz1cu1CKXRw9J5s6fjIi3FcYxhGbLYT5nkf9r4fTnTWQmsTEEIGlFQoVUZyuKaFyQsUPC9khkXb9eiItV6whjEtmsaibR2sG46Td86NaOoODQNejMNn5vAmO3zknEuD92uN19xiYUyHsjSoqjpMzel3L1askKxJUxmQgjvPdnmJ55XAIU7wGMV4uIpxiBI8+cKar3qB1s0fTN1SIi5Ykb4ocaskbpTClKYY4hhjEmPKFAu/hefoilIW/vzZCS/kHPhn90JglgJbyjZRhInzjg+Ewv91AQpTcaw6l/rCsayw591uufwVJgn2LP8C2DG40z5/dREAAAAASUVORK5CYII='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="profiler 3"
        title=""
        src="/static/profiler-3-edc6feaba303de1b51fa7a80b876a922-fb8a0.png"
        srcset="/static/profiler-3-edc6feaba303de1b51fa7a80b876a922-1a291.png 148w,
/static/profiler-3-edc6feaba303de1b51fa7a80b876a922-2bc4a.png 295w,
/static/profiler-3-edc6feaba303de1b51fa7a80b876a922-fb8a0.png 590w,
/static/profiler-3-edc6feaba303de1b51fa7a80b876a922-526de.png 885w,
/static/profiler-3-edc6feaba303de1b51fa7a80b876a922-9160a.png 1024w"
        sizes="(max-width: 590px) 100vw, 590px"
      />
    </span>
  </span>
  
  </a>
    </p>
<h3>Common Performance Problems</h3>
<p>Here is a short list of a few common application performance problems I’ve encountered in the past:</p>
<ul>
<li>Unnecessary collection enumeration and allocation (<code class="language-text">.ToList()</code>)</li>
<li>String manipulation in loops</li>
<li>Using <code class="language-text">string.Substring()</code> instead of <code class="language-text">Span</code></li>
<li>Using <code class="language-text">string.Format</code> (or C# 6 interpolation via the <code class="language-text">$</code> operator) instead of <code class="language-text">string.Concat</code> for small operations</li>
<li>Not using async for I/O operations that can be executed in parallel</li>
<li>Wrapping synchronous operations in async wrappers and executing them synchronously. This results in the creation of unnecessary tasks and state machines.</li>
<li>Using <code class="language-text">List</code> instead of <code class="language-text">Dictionary</code> for key/id-based access. Or more generalized: choosing improper collection types.</li>
<li>Unnecessary boxing <code class="language-text">(var i = 0; object a = i; var j = (int)a;)</code></li>
<li>Large lock blocks or locking types. Use locks on static instance variables as close as possible to the synchronous operation. Consider the use of ThreadStatic or LocalAsync.</li>
</ul>
<h3>Conclusion</h3>
<p>At the end of the day, the quality of large-scale applications is limited by the quality of the processes that govern their development. Without proper pre-production processes, we will inevitably release poor-performing code to our users. Through the use of pre-production tooling such as Prefix and Retrace on staging environments, we can gain quick insights into the performance impact of changes. Once we have identified possible issues, we can follow the procedure outlined above to correct performance problems before they bring down critical systems.</p>
<p>If you found this post helpful or if you have any questions, let me know in the comments!</p>
<h3>Additional Resources</h3>
<ul>
<li><a href="http://benchmarkdotnet.org/">BenchmarkDotNet</a></li>
<li><a href="https://docs.microsoft.com/en-us/visualstudio/profiling/beginners-guide-to-performance-profiling">Profile application performance in Visual Studio</a></li>
<li><a href="https://www.jetbrains.com/dotmemory/">dotMemory</a> | <a href="https://www.jetbrains.com/profiler/">dotTrace</a> from JetBrains</li>
<li><a href="https://github.com/Microsoft/perfview">Microsoft PerfView</a></li>
<li><a href="http://www.writinghighperf.net/buy/">Writing High-Performance .Net Code</a> by <a href="https://twitter.com/benmwatson">Ben Watson</a></li>
<li><a href="https://www.ageofascent.com/2017/11/05/perfromance-dotnet-core-2-corestart-conference/">Corestart 2.0: What’s new for performance in .NET Core 2.0</a> by <a href="https://twitter.com/ben_a_adams">Ben Adams</a></li>
</ul></div><hr style="margin-bottom:1.75rem;" data-reactid="9"/><div style="display:flex;margin-bottom:4.375rem;" data-reactid="10"><img src="/static/profile-pic.4eeca420.png" alt="jaredcnance" style="margin-right:0.875rem;margin-bottom:0;margin-top:1.575rem;width:3.5rem;height:3.5rem;" data-reactid="11"/><p data-reactid="12"><!-- react-text: 13 -->My name is <!-- /react-text --><strong data-reactid="14">Jared Nance</strong><!-- react-text: 15 -->, I live and work in Kansas City. I enjoy building things and sharing what I learn along the way.<!-- /react-text --><!-- react-text: 16 --> <!-- /react-text --><!-- react-text: 17 -->You can follow me on<!-- /react-text --><!-- react-text: 18 --> <!-- /react-text --><a href="https://twitter.com/jaredcnance" data-reactid="19">Twitter</a><!-- react-text: 20 --> or<!-- /react-text --><!-- react-text: 21 --> <!-- /react-text --><a href="https://github.com/jaredcnance" data-reactid="22">GitHub</a></p></div><ul style="display:flex;flex-wrap:wrap;justify-content:space-between;list-style:none;padding:0;" data-reactid="23"><li data-reactid="24"><a rel="prev" href="/logging-in-azure-functions/" data-reactid="25"><!-- react-text: 26 -->← <!-- /react-text --><!-- react-text: 27 -->A Guide to Logging in Azure Functions<!-- /react-text --></a></li><li data-reactid="28"><a rel="next" href="/leveling-up-your-dotnet-testing/" data-reactid="29"><!-- react-text: 30 -->Leveling Up Your .Net Testing Patterns - Part I<!-- /react-text --><!-- react-text: 31 --> →<!-- /react-text --></a></li></ul></div><span style="display:block;clear:both;" data-reactid="32"> </span></div></div><script id="webpack-manifest">/*<![CDATA[*/window.webpackManifest={"231608221292675":"app-a5e665fcdbad95c1eeb3.js","99219681209289":"component---node-modules-gatsby-plugin-offline-app-shell-js-5c4c5a0f7af9dc69d6d7.js","107818501498521":"component---src-templates-blog-post-js-086e07739fc65e01f8db.js","162898551421021":"component---src-pages-404-js-4503918ea3a16cfcdb75.js","35783957827783":"component---src-pages-index-js-60fad39aa6d61a87ce0f.js","60335399758886":"path----557518bd178906f8d58a.js","210333531512890":"path---offline-plugin-app-shell-fallback-a0e39f21c11f6a62c5ab.js","70179299880030":"path---leveling-up-your-dotnet-testing-transactional-integration-testing-in-asp-net-core-0d3194025c75e6f3ae24.js","163616910017581":"path---leveling-up-your-dotnet-testing-327c5a78ae046bfd7421.js","130323105709194":"path---dotnet-performance-optimization-815dda98c5b44a663c33.js","106575918426696":"path---logging-in-azure-functions-c2dd920db5b4cfee9635.js","68384136547871":"path---dotnet-core-dependency-injection-57709773b4c081d4b60d.js","180578961852115":"path---typescript-vs-javascript-e3979dccbdd9363699eb.js","47572940128521":"path---hangfire-tasks-in-dotnet-core-499b654f768ca73494d8.js","254022195166212":"path---404-a0e39f21c11f6a62c5ab.js","142629428675168":"path---index-0b061746fd1d8a417bf7.js","178698757827068":"path---404-html-a0e39f21c11f6a62c5ab.js","114276838955818":"component---src-layouts-index-js-c56dd00f07d25fed4a16.js"}/*]]>*/</script><script>
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-116668380-1', 'auto');
      }
      </script><script>/*<![CDATA[*/!function(e,t,r){function n(){for(;d[0]&&"loaded"==d[0][f];)c=d.shift(),c[o]=!i.parentNode.insertBefore(c,i)}for(var s,a,c,d=[],i=e.scripts[0],o="onreadystatechange",f="readyState";s=r.shift();)a=e.createElement(t),"async"in i?(a.async=!1,e.head.appendChild(a)):i[f]?(d.push(a),a[o]=n):e.write("<"+t+' src="'+s+'" defer></'+t+">"),a.src=s}(document,"script",["/commons-052854b14b2d9cebb713.js","/app-a5e665fcdbad95c1eeb3.js","/path---dotnet-performance-optimization-815dda98c5b44a663c33.js","/component---src-templates-blog-post-js-086e07739fc65e01f8db.js","/component---src-layouts-index-js-c56dd00f07d25fed4a16.js"])/*]]>*/</script></body></html>