<!DOCTYPE html><html><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><link rel="preload" href="/component---src-layouts-index-js-c56dd00f07d25fed4a16.js" as="script"/><link rel="preload" href="/component---src-templates-blog-post-js-086e07739fc65e01f8db.js" as="script"/><link rel="preload" href="/path---leveling-up-your-dotnet-testing-transactional-integration-testing-in-asp-net-core-078963407646d114cd1f.js" as="script"/><link rel="preload" href="/app-a5e665fcdbad95c1eeb3.js" as="script"/><link rel="preload" href="/commons-052854b14b2d9cebb713.js" as="script"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><title data-react-helmet="true">Leveling Up Your .Net Testing Patterns - Part II Transactional Integration Testing | nance.io</title><meta data-react-helmet="true" property="og:title" content="Leveling Up Your .Net Testing Patterns - Part II Transactional Integration Testing | nance.io"/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" property="og:image" content="/static/fallback.9c01bf00.jpg"/><meta data-react-helmet="true" property="og:description" content="Increase performance, reduce boilerplate, and improve DX through transactional integration testing. Working examples included."/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:site" content="@jaredcnance"/><meta data-react-helmet="true" name="twitter:title" content="Leveling Up Your .Net Testing Patterns - Part II Transactional Integration Testing | nance.io"/><meta data-react-helmet="true" name="twitter:description" content="Increase performance, reduce boilerplate, and improve DX through transactional integration testing. Working examples included."/><meta data-react-helmet="true" name="twitter:image" content="/static/fallback.9c01bf00.jpg"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:100%/1.75 'Merriweather','Georgia',serif;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.9);font-family:'Merriweather','Georgia',serif;font-weight:400;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:Montserrat,sans-serif;font-weight:900;text-rendering:optimizeLegibility;font-size:2.5rem;line-height:1.1;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.73286rem;line-height:1.1;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.4427rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;letter-spacing:0.140625em;text-transform:uppercase;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.83255rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.75966rem;line-height:1.1;font-style:italic;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}ul{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;list-style:disc;}ol{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}p{margin-left:0;margin-right:0;margin-top:1.2rem;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.2rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:0.85rem;line-height:1.75rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1rem;line-height:1.75rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}blockquote{margin-left:-1.75rem;margin-right:1.75rem;margin-top:0;padding-bottom:0;padding-left:1.42188rem;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1.20112rem;line-height:1.75rem;color:hsla(0,0%,0%,0.59);font-style:italic;border-left:0.32813rem solid hsla(0,0%,0%,0.9);}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.75rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}b{font-weight:700;}strong{font-weight:700;}dt{font-weight:700;}th{font-weight:700;}li{margin-bottom:calc(1.75rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}li > ul{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(1.75rem / 2);}code{font-size:0.85rem;line-height:1.75rem;}kbd{font-size:0.85rem;line-height:1.75rem;}samp{font-size:0.85rem;line-height:1.75rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.16667rem;padding-right:1.16667rem;padding-top:0.875rem;padding-bottom:calc(0.875rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}blockquote > :last-child{margin-bottom:0;}blockquote cite{font-size:1rem;line-height:1.75rem;color:hsla(0,0%,0%,0.9);font-weight:400;}blockquote cite:before{content:"— ";}ul,ol{margin-left:0;}@media only screen and (max-width:480px){ul,ol{margin-left:1.75rem;}blockquote{margin-left:-1.3125rem;margin-right:0;padding-left:0.98438rem;}}h1,h2,h3,h4,h5,h6{margin-top:3.5rem;}a{box-shadow:0 1px 0 0 currentColor;color:#007acc;text-decoration:none;}a:hover,a:active{box-shadow:none;}mark,ins{background:#007acc;color:white;padding:0.10938rem 0.21875rem;text-decoration:none;}a.gatsby-resp-image-link{box-shadow:none;}</style><style id="gatsby-inlined-css">code[class*=language-],pre[class*=language-]{color:#bfc7d5;background:none;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;background:#292d3e}:not(pre)>code[class*=language-]{color:#292d3e;background-color:rgba(191,199,213,.53333);padding:.1em .3em;border-radius:.3em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#697098}.token.class-name,.token.punctuation{color:#82aaff}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#ff5572}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#ffcb6b}.token.constant,.token.property,.token.symbol{color:#c3e88d}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#bf79db}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#c3e88d}.token.entity,.token.operator,.token.url{color:#80cbc4}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:#66d9ef}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:100;src:local("Montserrat Thin "),local("Montserrat-Thin"),url(/static/montserrat-latin-100.50d27986.woff2) format("woff2"),url(/static/montserrat-latin-100.5e334eff.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:100;src:local("Montserrat Thin italic"),local("Montserrat-Thinitalic"),url(/static/montserrat-latin-100italic.8c070533.woff2) format("woff2"),url(/static/montserrat-latin-100italic.03e19243.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:200;src:local("Montserrat Extra Light "),local("Montserrat-Extra Light"),url(/static/montserrat-latin-200.4343d3d9.woff2) format("woff2"),url(/static/montserrat-latin-200.f2022ecd.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:200;src:local("Montserrat Extra Light italic"),local("Montserrat-Extra Lightitalic"),url(/static/montserrat-latin-200italic.116c4c4b.woff2) format("woff2"),url(/static/montserrat-latin-200italic.89614a60.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:300;src:local("Montserrat Light "),local("Montserrat-Light"),url(/static/montserrat-latin-300.d2ad295b.woff2) format("woff2"),url(/static/montserrat-latin-300.3a371ee0.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:300;src:local("Montserrat Light italic"),local("Montserrat-Lightitalic"),url(/static/montserrat-latin-300italic.f6b6bf24.woff2) format("woff2"),url(/static/montserrat-latin-300italic.16521668.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:400;src:local("Montserrat Regular "),local("Montserrat-Regular"),url(/static/montserrat-latin-400.240a8444.woff2) format("woff2"),url(/static/montserrat-latin-400.b20cc131.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:400;src:local("Montserrat Regular italic"),local("Montserrat-Regularitalic"),url(/static/montserrat-latin-400italic.86172bb8.woff2) format("woff2"),url(/static/montserrat-latin-400italic.9405e787.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:500;src:local("Montserrat Medium "),local("Montserrat-Medium"),url(/static/montserrat-latin-500.fb8d6b71.woff2) format("woff2"),url(/static/montserrat-latin-500.50825d47.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:500;src:local("Montserrat Medium italic"),local("Montserrat-Mediumitalic"),url(/static/montserrat-latin-500italic.c0a555a4.woff2) format("woff2"),url(/static/montserrat-latin-500italic.635de59c.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:600;src:local("Montserrat SemiBold "),local("Montserrat-SemiBold"),url(/static/montserrat-latin-600.d5615136.woff2) format("woff2"),url(/static/montserrat-latin-600.f300da4f.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:600;src:local("Montserrat SemiBold italic"),local("Montserrat-SemiBolditalic"),url(/static/montserrat-latin-600italic.10f29d13.woff2) format("woff2"),url(/static/montserrat-latin-600italic.2bc37d86.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:700;src:local("Montserrat Bold "),local("Montserrat-Bold"),url(/static/montserrat-latin-700.7d77e1f0.woff2) format("woff2"),url(/static/montserrat-latin-700.81826529.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:700;src:local("Montserrat Bold italic"),local("Montserrat-Bolditalic"),url(/static/montserrat-latin-700italic.1dd2b53f.woff2) format("woff2"),url(/static/montserrat-latin-700italic.c162d257.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:800;src:local("Montserrat ExtraBold "),local("Montserrat-ExtraBold"),url(/static/montserrat-latin-800.d4e7bf86.woff2) format("woff2"),url(/static/montserrat-latin-800.895aadbf.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:800;src:local("Montserrat ExtraBold italic"),local("Montserrat-ExtraBolditalic"),url(/static/montserrat-latin-800italic.fc0cbe44.woff2) format("woff2"),url(/static/montserrat-latin-800italic.b3362875.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:900;src:local("Montserrat Black "),local("Montserrat-Black"),url(/static/montserrat-latin-900.c8bdd772.woff2) format("woff2"),url(/static/montserrat-latin-900.1b99ef78.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:900;src:local("Montserrat Black italic"),local("Montserrat-Blackitalic"),url(/static/montserrat-latin-900italic.cb72c1f9.woff2) format("woff2"),url(/static/montserrat-latin-900italic.b78bb9f8.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:300;src:local("Merriweather Light "),local("Merriweather-Light"),url(/static/merriweather-latin-300.f015f1e9.woff2) format("woff2"),url(/static/merriweather-latin-300.92dfe81b.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:300;src:local("Merriweather Light italic"),local("Merriweather-Lightitalic"),url(/static/merriweather-latin-300italic.7fd86b32.woff2) format("woff2"),url(/static/merriweather-latin-300italic.878b76f5.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:400;src:local("Merriweather Regular "),local("Merriweather-Regular"),url(/static/merriweather-latin-400.12dbf4c0.woff2) format("woff2"),url(/static/merriweather-latin-400.1fffad22.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:400;src:local("Merriweather Regular italic"),local("Merriweather-Regularitalic"),url(/static/merriweather-latin-400italic.1e0d3e81.woff2) format("woff2"),url(/static/merriweather-latin-400italic.de18d4c4.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:700;src:local("Merriweather Bold "),local("Merriweather-Bold"),url(/static/merriweather-latin-700.dc8fec81.woff2) format("woff2"),url(/static/merriweather-latin-700.d7d2ed8e.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:700;src:local("Merriweather Bold italic"),local("Merriweather-Bolditalic"),url(/static/merriweather-latin-700italic.b7b7e5da.woff2) format("woff2"),url(/static/merriweather-latin-700italic.6210a5fc.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:900;src:local("Merriweather Black "),local("Merriweather-Black"),url(/static/merriweather-latin-900.43f870d5.woff2) format("woff2"),url(/static/merriweather-latin-900.8f3806df.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:900;src:local("Merriweather Black italic"),local("Merriweather-Blackitalic"),url(/static/merriweather-latin-900italic.168c1ab2.woff2) format("woff2"),url(/static/merriweather-latin-900italic.ae7778f0.woff) format("woff")}</style></head><body><div id="___gatsby"><div style="max-width:42rem;margin-left:auto;margin-right:auto;padding:2.625rem 1.3125rem;" data-reactroot="" data-reactid="1" data-react-checksum="849792446"><h3 style="font-family:Montserrat, sans-serif;margin-top:0;margin-bottom:-1.75rem;" data-reactid="2"><a style="box-shadow:none;text-decoration:none;color:inherit;" href="/" data-reactid="3">nance.io</a></h3><div data-reactid="4"><!-- react-empty: 5 --><h1 data-reactid="6">Leveling Up Your .Net Testing Patterns - Part II Transactional Integration Testing</h1><p style="font-size:0.83255rem;line-height:1.75rem;display:block;margin-bottom:1.75rem;margin-top:-1.75rem;" data-reactid="7">April 14, 2018</p><div data-reactid="8"><p>In <a href="http://nance.io/leveling-up-your-dotnet-testing/">part 1</a> of this blog post, I introduced a few testing patterns.
Specifically I showed how you can use factories to generate fake data and create randomness in our tests.
This can improve the coverage of possible input parameters and possibly expose unexpected application bugs.</p>
<p>In this post we’ll be moving on to integration testing.
I’ll show a few options for making our integration tests idempotent even in the face of concurrent execution.
Almost all of the examples below will be using <a href="https://github.com/aspnet/EntityFrameworkCore">Entity Framework Core</a>.
At the end I’ll quickly show how the same principles can be applied using any data access layer that provides
<code class="language-text">IDbTransaction</code> capabilities, such as <a href="https://github.com/StackExchange/Dapper">Dapper</a>.</p>
<p>I’ll be using <a href="https://xunit.github.io/">xUnit</a> for the testing framework.
However, you should be able to do these same things with other frameworks by using the APIs they provide to share test between tests.</p>
<center><a href="https://github.com/jaredcnance/TransactionalTests" target="_blank">Skip to the example repo</a></center>
<p>An integration test is one that tests multiple layers of our application, often times extending all the way to the data persistence layer.
The following is an example of an integration test that verifies an <code class="language-text">ArticleService</code> can fetch all articles from the database.
To do this, we need to first create some articles to query.</p>
<div class="gatsby-highlight">
      <pre class="language-csharp"><code class="language-csharp"><span class="token punctuation">[</span>Fact<span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">async</span> Task <span class="token function">GetAllAsync_Returns_All_Articles</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// arrange</span>
    <span class="token keyword">var</span> expectedArticleCount <span class="token operator">=</span> _faker<span class="token punctuation">.</span>Random<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> expectedArticles <span class="token operator">=</span> ArticleFactory<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>expectedArticleCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    DbContext<span class="token punctuation">.</span>Articles<span class="token punctuation">.</span><span class="token function">AddRange</span><span class="token punctuation">(</span>expectedArticles<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> DbContext<span class="token punctuation">.</span><span class="token function">SaveChangesAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArticleService</span><span class="token punctuation">(</span>DbContext<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// act</span>
    <span class="token keyword">var</span> actualArticles <span class="token operator">=</span> <span class="token keyword">await</span> service<span class="token punctuation">.</span><span class="token function">GetAllAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// assert</span>
    Assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>expectedArticleCount<span class="token punctuation">,</span> actualArticles<span class="token punctuation">.</span>Count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
      </div>
<p>The problem with this test is that it <strong>assumes the database is empty</strong>.
If there are other tests concurrently accessing the database, this is unlikely to be true.
At a minimum, there is the possibility that other tests might occasionally invalidate
that assumption causing the test to act “flaky”.</p>
<h2>Option 1: Serial Execution</h2>
<p>One naïve option is to force serial execution of the tests and make sure each test cleans up after itself.
Generally, to avoid a lot of cleanup code, a test fixture may just drop and re-create the database on
every run. However, as your number of tests increases, this will get painfully slow
even if your tests are run asynchronously from your development workflow via a build server.
Also, this encourages the poor habit of not running tests locally.</p>
<h2>Option 2: In Memory Databases</h2>
<p>If you’re using Entity Framework, a good option is using the <code class="language-text">Microsoft.EntityFrameworkCore.InMemory</code>
package for running your database. You just need to be aware that it limits
the scope of what is actually being tested. Some of these limitations have been
<a href="https://docs.microsoft.com/en-us/ef/core/miscellaneous/testing/in-memory">enumerated in the docs</a>.</p>
<blockquote>
<ul>
<li>
<p>InMemory will allow you to save data that would violate referential integrity constraints in a relational database.</p>
</li>
<li>
<p>If you use DefaultValueSql(string) for a property in your model, this is a relational database API and will have no effect when running against InMemory.</p>
</li>
</ul>
</blockquote>
<p>In addition to these limitations, you may run into issues if your models depend on provider specific data types or constraints.
For example, a PostgreSQL specific column type, will not be handled by the in memory provider and is unlikely to expose data type related issues.
Consider the following model property:</p>
<div class="gatsby-highlight">
      <pre class="language-csharp"><code class="language-csharp"><span class="token punctuation">[</span><span class="token function">Column</span><span class="token punctuation">(</span>TypeName <span class="token operator">=</span> <span class="token string">"int2"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> Ordinal <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
</code></pre>
      </div>
<p>I have defined a column type of <code class="language-text">int2</code> (16 bit integer) but declared the .Net type to be <code class="language-text">int</code> (32 bit integer).
The in-memory provider will be unable to detect truncation issues since it has no way to determine what <code class="language-text">int2</code> means.
So, your tests may pass, but you are at risk for hitting errors such as this one in production:</p>
<div class="gatsby-highlight">
      <pre class="language-text"><code class="language-text"> Microsoft.EntityFrameworkCore.DbUpdateException : An error occurred while updating the entries. See the inner exception for details.
---- System.OverflowException : Value was either too large or too small for an Int16.</code></pre>
      </div>
<p>Other limitations include the lack of support for relational APIs such as migrations and transactions.</p>
<h2>Option 3: Transactional Testing</h2>
<p>The alternative that I would like to propose is transactional testing.
Transactional tests are tests that get wrapped in a database transaction and are rolled back when the test completes.
We can run our tests in an isolated <a href="https://docs.microsoft.com/en-us/ef/core/saving/transactions">Entity Framework transaction</a>.
An example transaction might look like:</p>
<div class="gatsby-highlight">
      <pre class="language-csharp"><code class="language-csharp"><span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token keyword">var</span> transaction <span class="token operator">=</span> _dbContext<span class="token punctuation">.</span>Database<span class="token punctuation">.</span><span class="token function">BeginTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">try</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// do some work that requires calling SaveChanges multiple times...</span>
        transaction<span class="token punctuation">.</span><span class="token function">Commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        transaction<span class="token punctuation">.</span><span class="token function">Rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
      </div>
<p>The call to <a href="https://github.com/aspnet/EntityFrameworkCore/blob/1d2178f38d231599b53f899af498107fc1db39d9/src/EFCore.Relational/Storage/RelationalConnection.cs#L246"><code class="language-text">BeginTransaction</code></a>
will begin an <a href="https://docs.microsoft.com/en-us/dotnet/framework/data/adonet/local-transactions">ADO.NET transaction</a>
and subsequent calls to <code class="language-text">SaveChanges</code> will use the open transaction.
When the <code class="language-text">DbContext</code> is disposed it will rollback the transaction if it has not already been committed.</p>
<p>Wrapping integration tests in transactions is not a new concept and it comes out-of-the-box <a href="https://github.com/rails/rails/commit/903ef71b9952f4bfaef798bbd93a972fc25010ad">in Rails</a>,
<a href="https://hexdocs.pm/phoenix/testing.html">Phoenix</a> and I’m sure other frameworks as well.
However, since .Net is much less opinionated than these frameworks, it’s not reasonable to expect this to be a built-in feature (yet :fingers_crossed:).</p>
<p>Let’s take a look at the simplest use of transactions in integration tests.
We’re going to test that an <code class="language-text">ArticleService</code> persists data to the database:</p>
<div class="gatsby-highlight">
      <pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">async</span> Task <span class="token function">CreateAsync_Persists_Article</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token keyword">var</span> transaction <span class="token operator">=</span> _dbContext<span class="token punctuation">.</span>Database<span class="token punctuation">.</span><span class="token function">BeginTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// arrange</span>
            <span class="token keyword">var</span> article <span class="token operator">=</span> ArticleFactory<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArticleService</span><span class="token punctuation">(</span>_dbContext<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// act</span>
            <span class="token keyword">await</span> service<span class="token punctuation">.</span><span class="token function">CreateAsync</span><span class="token punctuation">(</span>article<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// will call _dbContext.SaveChanges();</span>

            <span class="token comment">// assert</span>
            <span class="token keyword">var</span> dbArticle <span class="token operator">=</span> <span class="token keyword">await</span> _dbContext<span class="token punctuation">.</span>Articles<span class="token punctuation">.</span><span class="token function">Single</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Assert<span class="token punctuation">.</span><span class="token function">NotNull</span><span class="token punctuation">(</span>dbArticle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">finally</span>
        <span class="token punctuation">{</span>
            transaction<span class="token punctuation">.</span><span class="token function">Rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
      </div>
<p>By using the transaction, we can ensure that the changes to the <code class="language-text">DbContext</code> are rolled back upon test completion.
SQLServer, PostgreSQL and Oracle 11g all use
<a href="https://www.postgresql.org/docs/9.5/static/transaction-iso.html">Read Committed isolation</a> by default.
What this means is that the changes within this transaction will not be visible to other concurrent transactions.</p>
<h2>Fixtures</h2>
<p>At this point, we have a strategy testing our database-dependent services without having to mock the database provider.
However, it would be pretty annoying if we had to wrap all our tests in this transactional boilerplate.</p>
<p><strong>Enter fixtures</strong></p>
<p>We can use fixtures to get the boilerplate out of the way.
In xUnit, fixtures can be created through inheritance since each test is run using a new instance of the test class.
Here is an example where we create a transaction in an inherited fixture that implements <code class="language-text">IDisposable</code>.</p>
<div class="gatsby-highlight">
      <pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DbContextFixture</span> <span class="token punctuation">:</span> IDisposable
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> IDbContextTransaction Transaction <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">protected</span> AppDbContext DbContext <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">DbContextFixture</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// configure our database</span>
        <span class="token keyword">var</span> options <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DbContextOptionsBuilder</span><span class="token operator">&lt;</span>AppDbContext<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">UseNpgsql</span><span class="token punctuation">(</span><span class="token comment">/* ... */</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span>Options<span class="token punctuation">;</span>

        DbContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AppDbContext</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// begin the transaction</span>
        Transaction <span class="token operator">=</span> DbContext<span class="token punctuation">.</span>Database<span class="token punctuation">.</span><span class="token function">BeginTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Transaction <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            Transaction<span class="token punctuation">.</span><span class="token function">Rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Transaction<span class="token punctuation">.</span><span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestClass</span> <span class="token punctuation">:</span> DbContextFixture <span class="token punctuation">{</span> <span class="token comment">/* ... */</span> <span class="token punctuation">}</span>
</code></pre>
      </div>
<p>When our test gets disposed, the transaction will be rolled back.</p>
<h2>Transactions Using ASP.Net Core TestServer</h2>
<p>Things get a little more interesting when we decide to run end-to-end tests.
ASP.Net Core has a set of APIs that you can use – available in the <code class="language-text">Microsoft.AspNetCore.TestHost</code> package –
to create an in memory web server.
This allows you to validate your entire web application (serializers, routing, controllers, services, etc.) in your tests.
This is a fantastic way to write E2E application tests.</p>
<p>An example fixture for web services might look like:</p>
<div class="gatsby-highlight">
      <pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebFixture</span><span class="token operator">&lt;</span>TStartup<span class="token operator">></span> <span class="token punctuation">:</span> IDisposable <span class="token keyword">where</span> TStartup <span class="token punctuation">:</span> <span class="token keyword">class</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> TestServer _server<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> IServiceProvider _services<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> IDbContextTransaction _transaction<span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token keyword">readonly</span> HttpClient Client<span class="token punctuation">;</span>
    <span class="token keyword">protected</span> AppDbContext DbContext <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">WebFixture</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">var</span> builder <span class="token operator">=</span> WebHost<span class="token punctuation">.</span><span class="token function">CreateDefaultBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token generic-method function">UseStartup<span class="token punctuation">&lt;</span>TStartup<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// construct the test server and client we'll use to</span>
        <span class="token comment">// send requests</span>
        _server <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TestServer</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Client <span class="token operator">=</span> _server<span class="token punctuation">.</span><span class="token function">CreateClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _services <span class="token operator">=</span> _server<span class="token punctuation">.</span>Host<span class="token punctuation">.</span>Services<span class="token punctuation">;</span>

        <span class="token comment">// resolve a DbContext instance from the container</span>
        <span class="token comment">// and begin a transaction on the context.</span>
        DbContext <span class="token operator">=</span> <span class="token generic-method function">GetService<span class="token punctuation">&lt;</span>AppDbContext<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _transaction <span class="token operator">=</span> DbContext<span class="token punctuation">.</span>Database<span class="token punctuation">.</span><span class="token function">BeginTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> T <span class="token generic-method function">GetService<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span>T<span class="token punctuation">)</span>_services<span class="token punctuation">.</span><span class="token function">GetService</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_transaction <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            _transaction<span class="token punctuation">.</span><span class="token function">Rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            _transaction<span class="token punctuation">.</span><span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
      </div>
<p>And then our test can use the fixture to send requests to the server.</p>
<div class="gatsby-highlight">
      <pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Articles_Tests</span> <span class="token punctuation">:</span> WebFixture<span class="token operator">&lt;</span>TestStartup<span class="token operator">></span>
<span class="token punctuation">{</span>
    <span class="token punctuation">[</span>Fact<span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> Task <span class="token keyword">async</span> <span class="token function">Can_Get_Articles</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// arrange</span>
        <span class="token keyword">var</span> expectedArticles <span class="token operator">=</span> _faker<span class="token punctuation">.</span>Random<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> articles <span class="token operator">=</span> ArticleFactory<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>expectedArticles<span class="token punctuation">)</span><span class="token punctuation">;</span>
        DbContext<span class="token punctuation">.</span>Articles<span class="token punctuation">.</span><span class="token function">AddRange</span><span class="token punctuation">(</span>articles<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> DbContext<span class="token punctuation">.</span><span class="token function">SaveChangesAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">const</span> <span class="token keyword">string</span> route <span class="token operator">=</span> $<span class="token string">"api/v1/articles"</span><span class="token punctuation">;</span>

        <span class="token comment">// act</span>
        <span class="token keyword">var</span> response <span class="token operator">=</span> <span class="token keyword">await</span> Client<span class="token punctuation">.</span><span class="token function">GetAsync</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// assert</span>

        <span class="token comment">// Generally, I prefer checking the status code first,</span>
        <span class="token comment">// since an error response may result in an exception during/after</span>
        <span class="token comment">// de-serialization. Knowing the returned status code is more helpful</span>
        <span class="token comment">// than an ambiguous exception thrown after failed de-serialization</span>
        Assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>HttpStatusCode<span class="token punctuation">.</span>OK<span class="token punctuation">,</span> response<span class="token punctuation">.</span>StatusCode<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// I like to move de-serialization into the fixture since the process</span>
        <span class="token comment">// doesn't change much and is just boilerplate.</span>
        <span class="token comment">// DeserializeAsync&lt;T> might look like:</span>
        <span class="token comment">//</span>
        <span class="token comment">// var json = await response.Content.ReadAsStringAsync();</span>
        <span class="token comment">// return JsonConvert.DeserializeObject&lt;T>(json);</span>
        <span class="token keyword">var</span> deserializedArticles <span class="token operator">=</span> <span class="token keyword">await</span> DeserializeAsync<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>Article<span class="token operator">></span><span class="token operator">></span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>expectedArticles<span class="token punctuation">,</span> deserializedArticles<span class="token punctuation">.</span>Count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
      </div>
<p>However, we’re going to have a problem because if you have properly defined the
<code class="language-text">AppDbContext</code> DI registration scope as <code class="language-text">Scoped</code>, then the instance that is accessed
by the test will be different than the instance used by the web server and they will not
share a transaction scope.</p>
<p>In other words, the web server will return an empty set because it is unaware of the <code class="language-text">Articles</code> created in the currently uncommitted test transaction.
To handle this, we can create a new <code class="language-text">TestStartup</code> class that registers the <code class="language-text">AppDbContext</code> as a singleton.
Remember, that this is not an implementation of a traditional <a href="http://csharpindepth.com/Articles/General/Singleton.aspx">singleton pattern in C#</a>.
In this context the term “singleton” just means that any lookups on the <strong>same container instance</strong> will receive the same <strong>service instance</strong>.
This means transaction isolation is preserved between tests as long as tests do not share a <code class="language-text">TestServer</code> instance even if they run in the same process.</p>
<div class="gatsby-highlight">
      <pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestStartup</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span>IServiceCollection services<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        services<span class="token punctuation">.</span><span class="token generic-method function">AddSingleton<span class="token punctuation">&lt;</span>DbContext<span class="token punctuation">,</span> AppDbContext<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
      </div>
<h2>Creating the Database</h2>
<p>Finally, we need to make sure the database is created and all migrations have been applied.
To avoid a performance hit, we only want to run <code class="language-text">DbContext.Database.Migrate()</code> once.
One way to do this is to add one more fixture to our inheritance hierarchy that creates the database once in its static
constructor:</p>
<div class="gatsby-highlight">
      <pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Fixture</span>
<span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token function">Fixture</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">CreateDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">CreateDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">var</span> options <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DbContextOptionsBuilder</span><span class="token operator">&lt;</span>AppDbContext<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">UseNpgsql</span><span class="token punctuation">(</span><span class="token comment">/* ... */</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span>Options<span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">AppDbContext</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">.</span>Database<span class="token punctuation">.</span><span class="token function">Migrate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebFixture</span><span class="token operator">&lt;</span>TStartup<span class="token operator">></span> <span class="token punctuation">:</span> Fixture<span class="token punctuation">,</span>
    IDisposable
    <span class="token keyword">where</span> TStartup <span class="token punctuation">:</span> <span class="token keyword">class</span>
<span class="token punctuation">{</span> <span class="token comment">/* ... */</span> <span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Articles_Tests</span> <span class="token punctuation">:</span> WebFixture<span class="token operator">&lt;</span>TestStartup<span class="token operator">></span>
<span class="token punctuation">{</span> <span class="token comment">/* ... */</span> <span class="token punctuation">}</span>
</code></pre>
      </div>
<h2>Not Using Entity Framework?</h2>
<p>As long as you’re using an ORM or data access layer that can create transactions, this is no problem.
Here is what your fixture might look like if you’re using Dapper:</p>
<div class="gatsby-highlight">
      <pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DapperFixture</span> <span class="token punctuation">:</span> Fixture<span class="token punctuation">,</span> IDisposable
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">DapperFixture</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Connection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NpgsqlConnection</span><span class="token punctuation">(</span>Configuration<span class="token punctuation">[</span><span class="token string">"DbConnection"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Connection<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Transaction <span class="token operator">=</span> Connection<span class="token punctuation">.</span><span class="token function">BeginTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> IDbConnection Connection <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">protected</span> IDbTransaction Transaction <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>Transaction <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            Transaction<span class="token punctuation">.</span><span class="token function">Rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Transaction<span class="token punctuation">.</span><span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Connection<span class="token punctuation">.</span><span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
      </div>
<p>This requires your application to be structured in such a way that you can substitute an <code class="language-text">IDbConnection</code>.
If you’re using the repository pattern, an example might look like:</p>
<div class="gatsby-highlight">
      <pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ArticleRepository</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> IDbConnection _dbConnection<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">ArticleRepository</span><span class="token punctuation">(</span>IDbConnection dbConnection<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _dbConnection <span class="token operator">=</span> dbConnection<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>Article<span class="token operator">></span><span class="token operator">></span> <span class="token function">GetArticlesAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token keyword">await</span> _dbConnection<span class="token punctuation">.</span><span class="token generic-method function">GetAllAsync<span class="token punctuation">&lt;</span>Article<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
      </div>
<p>In this case, you’d be able to test the <code class="language-text">ArticleRepository</code> directly by constructing it with an instance
of <code class="language-text">DapperFixture.Connection</code> which will be wrapped in a transaction.</p>
<h2>Summary</h2>
<p>With the solutions provided above, you’ll be able to write transactional integration tests that run in isolation
and reduce the amount of cleanup code you’ll be required to write.
There is also a huge performance benefit if you’ve been dropping and re-creating your databases between test runs
since the database only has to be created once.
I’ve provided a full example that uses <a href="https://github.com/jaredcnance/TransactionalTests/blob/master/test/WebAppTests/AcceptanceTests/Articles_Tests.cs">Entity Framework</a>
and also one that uses
<a href="https://github.com/jaredcnance/TransactionalTests/blob/master/test/WebAppTests/IntegrationTests/ArticleRepository_Tests.cs">Dapper</a> in the
<a href="https://github.com/jaredcnance/TransactionalTests">corresponding GitHub repository</a>.</p></div><hr style="margin-bottom:1.75rem;" data-reactid="9"/><div style="display:flex;margin-bottom:4.375rem;" data-reactid="10"><img src="/static/profile-pic.4eeca420.png" alt="jaredcnance" style="margin-right:0.875rem;margin-bottom:0;margin-top:1.575rem;width:3.5rem;height:3.5rem;" data-reactid="11"/><p data-reactid="12"><!-- react-text: 13 -->My name is <!-- /react-text --><strong data-reactid="14">Jared Nance</strong><!-- react-text: 15 -->, I live and work in Kansas City. I enjoy building things and sharing what I learn along the way.<!-- /react-text --><!-- react-text: 16 --> <!-- /react-text --><!-- react-text: 17 -->You can follow me on<!-- /react-text --><!-- react-text: 18 --> <!-- /react-text --><a href="https://twitter.com/jaredcnance" data-reactid="19">Twitter</a><!-- react-text: 20 --> or<!-- /react-text --><!-- react-text: 21 --> <!-- /react-text --><a href="https://github.com/jaredcnance" data-reactid="22">GitHub</a></p></div><ul style="display:flex;flex-wrap:wrap;justify-content:space-between;list-style:none;padding:0;" data-reactid="23"><li data-reactid="24"><a rel="prev" href="/leveling-up-your-dotnet-testing/" data-reactid="25"><!-- react-text: 26 -->← <!-- /react-text --><!-- react-text: 27 -->Leveling Up Your .Net Testing Patterns - Part I<!-- /react-text --></a></li></ul></div><span style="display:block;clear:both;" data-reactid="28"> </span></div></div><script id="webpack-manifest">/*<![CDATA[*/window.webpackManifest={"231608221292675":"app-a5e665fcdbad95c1eeb3.js","99219681209289":"component---node-modules-gatsby-plugin-offline-app-shell-js-5c4c5a0f7af9dc69d6d7.js","107818501498521":"component---src-templates-blog-post-js-086e07739fc65e01f8db.js","162898551421021":"component---src-pages-404-js-4503918ea3a16cfcdb75.js","35783957827783":"component---src-pages-index-js-60fad39aa6d61a87ce0f.js","60335399758886":"path----557518bd178906f8d58a.js","210333531512890":"path---offline-plugin-app-shell-fallback-a0e39f21c11f6a62c5ab.js","70179299880030":"path---leveling-up-your-dotnet-testing-transactional-integration-testing-in-asp-net-core-078963407646d114cd1f.js","163616910017581":"path---leveling-up-your-dotnet-testing-327c5a78ae046bfd7421.js","130323105709194":"path---dotnet-performance-optimization-815dda98c5b44a663c33.js","106575918426696":"path---logging-in-azure-functions-c2dd920db5b4cfee9635.js","68384136547871":"path---dotnet-core-dependency-injection-57709773b4c081d4b60d.js","180578961852115":"path---typescript-vs-javascript-e3979dccbdd9363699eb.js","47572940128521":"path---hangfire-tasks-in-dotnet-core-499b654f768ca73494d8.js","254022195166212":"path---404-a0e39f21c11f6a62c5ab.js","142629428675168":"path---index-86d2be220e027d891a7d.js","178698757827068":"path---404-html-a0e39f21c11f6a62c5ab.js","114276838955818":"component---src-layouts-index-js-c56dd00f07d25fed4a16.js"}/*]]>*/</script><script>
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-116668380-1', 'auto');
      }
      </script><script>/*<![CDATA[*/!function(e,t,r){function n(){for(;d[0]&&"loaded"==d[0][f];)c=d.shift(),c[o]=!i.parentNode.insertBefore(c,i)}for(var s,a,c,d=[],i=e.scripts[0],o="onreadystatechange",f="readyState";s=r.shift();)a=e.createElement(t),"async"in i?(a.async=!1,e.head.appendChild(a)):i[f]?(d.push(a),a[o]=n):e.write("<"+t+' src="'+s+'" defer></'+t+">"),a.src=s}(document,"script",["/commons-052854b14b2d9cebb713.js","/app-a5e665fcdbad95c1eeb3.js","/path---leveling-up-your-dotnet-testing-transactional-integration-testing-in-asp-net-core-078963407646d114cd1f.js","/component---src-templates-blog-post-js-086e07739fc65e01f8db.js","/component---src-layouts-index-js-c56dd00f07d25fed4a16.js"])/*]]>*/</script></body></html>