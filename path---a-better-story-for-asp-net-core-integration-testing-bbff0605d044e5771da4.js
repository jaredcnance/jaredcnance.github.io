webpackJsonp([0x9d1d86476678],{545:function(e,n){e.exports={data:{site:{siteMetadata:{title:"nance.io",author:"Jared Nance"}},markdownRemark:{id:"/Users/jarednance/dev/gatsby-blog/src/pages/a-better-story-for-asp-net-core-integration-testing/index.md absPath of file >>> MarkdownRemark",html:'<h1>tl;dr</h1>\n<p>I’ve built a library to improve the ergonomics and performance of your ASP.Net Core\nintegration tests. It allows you to write simple, elegant tests that run against an actual\ndatabase but don’t need to worry about side-effects. An example test might look like:</p>\n<div class="gatsby-highlight">\n      <pre class="language-csharp"><code class="language-csharp"><span class="token punctuation">[</span>Fact<span class="token punctuation">]</span>\n<span class="token keyword">public</span> <span class="token keyword">async</span> Task <span class="token function">Can_Get_All_Articles</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">{</span>\n    <span class="token comment">// arrange</span>\n    <span class="token keyword">var</span> article <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Article</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">await</span> DbContext<span class="token punctuation">.</span>Articles<span class="token punctuation">.</span><span class="token function">AddAsync</span><span class="token punctuation">(</span>article<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">await</span> DbContext<span class="token punctuation">.</span><span class="token function">SaveChangesAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// act</span>\n    <span class="token keyword">var</span> articles <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token generic-method function">GetAllAsync<span class="token punctuation">&lt;</span>Article<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token string">"articles"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// assert</span>\n    Assert<span class="token punctuation">.</span><span class="token function">Single</span><span class="token punctuation">(</span>articles<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre>\n      </div>\n<p>The test runs inside a transaction that gets rolled back when the test completes.\nThis allows other tests to assume the database is empty.\nManagement of the <code class="language-text">DbContext</code> and <code class="language-text">TestServer</code> is handled for you by the library.</p>\n<ul>\n<li><a href="https://github.com/jaredcnance/DotnetTestAbstractions">Source Code</a></li>\n<li><a href="https://www.nuget.org/packages/DotnetTestAbstractions">NuGet Package</a></li>\n</ul>\n<h1>Intro</h1>\n<p><a href="https://nance.io/leveling-up-your-dotnet-testing-transactional-integration-testing-in-asp-net-core/">In my last post</a>\nI showed an approach to using transactions in your ASP.Net Core integration tests.\nThis allows you to write tests that depend on database state, but do not require you to clean up the\ndatabase when you’re done.</p>\n<p><em>I recommend reading <a href="(https://nance.io/leveling-up-your-dotnet-testing-transactional-integration-testing-in-asp-net-core/)">my previous post</a> for reasons you would use this approach instead of the in-memory database.</em></p>\n<p>I included an example of a <code class="language-text">WebFixture</code> that sets up the <code class="language-text">TestServer</code>,\nregisters services and creates the <code class="language-text">IDbContextTransaction</code> for each test.\nHowever, we found the performance of this approach became unbearable for a few\nhundred tests after upgrading to dotnet core 2 (this included upgrading all the Microsoft.* packages).</p>\n<p>I spent a few weeks trying to understand the problem and improve the performance of our tests after the upgrade.\nIn this post I outline my process and the solution that <strong>reduced test execution time by 93%</strong>.</p>\n<h2>Investigating the Problem</h2>\n<p>My first step was to profile the application and see what was consuming so much time.\nI generally do all my work on my MBP, but there aren’t any good profilers that I’ve been able to find for OSX yet.\nSo, I booted up a <a href="https://developer.microsoft.com/en-us/windows/downloads/virtual-machines">Windows 10 development VM</a>\nusing VMWare and then used Visual Studio Community 2017 15.7.2 to start profiling the tests while they ran.</p>\n<p>Unfortunately, my initial CPU sampling approach didn’t yield much for me to work on.\nHowever, I did notice the test process memory continuing to grow unabated.</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/profile-1-96f44dd484a18e9eeae05152db767979-26ba6.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 590px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 49.20127795527157%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAACBElEQVQoz42SzW7TQBSF8668AM8AEkikNBS1TQupBDRNqFCFBOJvwYYNYglKaZrWdex44tjjv9jjsRMnPtwZCuoOrjSSx/fMp3PuTOPW7Xto7vZw//EhWnvH2D54jfbzN9h6eoLN/WNstF/iwU4fW50TtJ68Im2XtC9w9+EB7jQ76Dzbx9t3XXz41Mf7jz00HrV7KKUA9znCMITIMizKEmVRIJ3P4QURhMgxTxJac/oXIwy47mVZjp9DAzxM4Ew5RF6i0dw+RBJHMAwTlmXDnkzgujOEUYQ0zSCLUgMTgklZgPNQ7x2HkdbF4HSEi+F3OONzFGSk0SKHRZ7Btm0SOWCMISJYVVWo6xqq6nqN1Wqlv6WUWK/XBPbhzjgsgjrsDANjgFIBN3ePUFBk256AB4GG5XmuAQqqarFYaLECxXFMvTUCzjHzOEYmwzdjhi9DRv36N1CkCUzT1A4diqziZDTL5XKpgUII7Uztfd/XzpVD3w8wHLv4fGbh6wVDRSY0UIpUz0/F9TxPu1CulEt1uKALUvNTjgNKoZwqh2zq48epAZtxnF8ymNYMjY2dLg1pRcIQEYHUQQXLc3kds9aA6hq+XFY6snIbJSmuxoxGFYPxlIxk9Gz2+jrWzUv4V/3RyWIBczyhpxXjyi8wnQQ3gau/4v9ZqjIhMbq0MPViWO6cRhbiFzdy3x+Ml7UTAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"\n        alt="Profile results sorted by inclusive bytes"\n        title=""\n        src="/static/profile-1-96f44dd484a18e9eeae05152db767979-fb8a0.png"\n        srcset="/static/profile-1-96f44dd484a18e9eeae05152db767979-1a291.png 148w,\n/static/profile-1-96f44dd484a18e9eeae05152db767979-2bc4a.png 295w,\n/static/profile-1-96f44dd484a18e9eeae05152db767979-fb8a0.png 590w,\n/static/profile-1-96f44dd484a18e9eeae05152db767979-526de.png 885w,\n/static/profile-1-96f44dd484a18e9eeae05152db767979-fa2eb.png 1180w,\n/static/profile-1-96f44dd484a18e9eeae05152db767979-08f6a.png 1770w,\n/static/profile-1-96f44dd484a18e9eeae05152db767979-26ba6.png 2504w"\n        sizes="(max-width: 590px) 100vw, 590px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>What was happening was very similar to the issue described <a href="https://github.com/aspnet/EntityFrameworkCore/issues/10535">here</a>.\nEntityFramework’s <code class="language-text">ServiceProviderCache</code> was continuing to grow, creating a new <code class="language-text">ServiceProvider</code> per test.</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/profile-2-a933a08d2951642cd1abe633c4242fd3-36c4a.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 590px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 54.91731940818103%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAABkUlEQVQoz5WSzUsbURTF3x8sSCmiC0txIe4shJoWiqJIEi36J7irFRQ3bXHhR8b5yMtkkswkmY+8mXlvTu+8ZCALIXHgxzn3Lu479zLs8OQrzn9+Q7NVx8Xldxz8qOPj5xo2dmpY397H1u4BUceHT1+wtrm3FPb3yUAS+gh8D8NBd6bDPvqeiySJ8d6PHV/9w+nvNlp3Do6uX9G442jc2jj6ZaBxY+Dsvosm0dK4S2EPzyaeDAteECLJgVGSwY+miLICJu+RFwhThYmQK8Hahgnu2EjiSEculESepdoP+h5kls2XKVaCPbdNODQwDGcD8zyHEAJFUcDzPKRpSh5QqoAqlsNeKKFtmYiitwdm84RlvQrs8cUGd3sYTyaQUtFASakynWg0HkNQwqq/FEk3vP/zCId74JzDdV34foAgGBEzFSLFlBKXiDmLtfbTuSdlls318W3bRqfTgWVZerDjOJpy5fIMpVaUddVb9EopMO4OIKlRJprQ2mNaMwxD7cu7xnFMP3hCr0+1Vr6qF72klf8DEvAwGp9KbsUAAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"\n        alt="ServiceProvider instances owned by the ServiceProviderCache"\n        title=""\n        src="/static/profile-2-a933a08d2951642cd1abe633c4242fd3-fb8a0.png"\n        srcset="/static/profile-2-a933a08d2951642cd1abe633c4242fd3-1a291.png 148w,\n/static/profile-2-a933a08d2951642cd1abe633c4242fd3-2bc4a.png 295w,\n/static/profile-2-a933a08d2951642cd1abe633c4242fd3-fb8a0.png 590w,\n/static/profile-2-a933a08d2951642cd1abe633c4242fd3-526de.png 885w,\n/static/profile-2-a933a08d2951642cd1abe633c4242fd3-fa2eb.png 1180w,\n/static/profile-2-a933a08d2951642cd1abe633c4242fd3-08f6a.png 1770w,\n/static/profile-2-a933a08d2951642cd1abe633c4242fd3-36c4a.png 2298w"\n        sizes="(max-width: 590px) 100vw, 590px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>Each <code class="language-text">ServiceProvider</code> gets added to the static <a href="https://github.com/aspnet/EntityFrameworkCore/blob/e300fdfe4ac314cc9e65520a15b9b7609a6c6a21/src/EFCore/Internal/ServiceProviderCache.cs#L21-L22"><code class="language-text">ServiceProviderCache._configurations</code></a>\nwhich is persisted across test runs since they all run in the same process (AppDomains do not exist in .Net Core).\nSo, this <code class="language-text">ConcurrentDictionary</code> continued to grow:</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/profile-3-bbca9efff58870ac09624d413fcdb786-7615a.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 590px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 39.651162790697676%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsSAAALEgHS3X78AAABeklEQVQoz41SyW7bMBDV1/eWOE567Xf0kDRBkBgBei/QLG5cS6RIiqQkihS12H4ZEz3kUiQEHmbBzJuFk61FDSlKMM6R5zmKogBjLIGTr2AFlFJwrsNnXsaVRr7dwhgLrU0i1VqjrmuUpUgFOC/Rtg4hBHjvCeG/yHzXpQ6MMSmhI9sn6dE6lzqTUqWCIfQIfZ/kMfkY/95OhNbSyKYBtxHcRFTtgGmaMRKmf5h3+2T3cYCjQiFEDMNEZJEKExERDuOEGEci1AqP61dsWQkhBEGiUhK6UgmWxldSorEW0xDR1haxDxhJd00D71qwIqcYgXkckH37KXD6Y42z6xcsrteEPzi5fEr6ydULvnz/ja+3G5zf5Vjcl7h4qLBYKSzvGS5WHMsHjdObDRbEsVwJZN24h7Adnv8yPL7m+PW8QaEsVOOTX7sIWTuwqoHuBtgwoY47lNbRilzSVRuQSwPjaeTjVx92cxonBtqPP57H4eP7OOyB/e6dOae8N13RWM//8s3LAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"\n        alt="ServiceProviderCache Static Member Referencing ServiceProviders"\n        title=""\n        src="/static/profile-3-bbca9efff58870ac09624d413fcdb786-fb8a0.png"\n        srcset="/static/profile-3-bbca9efff58870ac09624d413fcdb786-1a291.png 148w,\n/static/profile-3-bbca9efff58870ac09624d413fcdb786-2bc4a.png 295w,\n/static/profile-3-bbca9efff58870ac09624d413fcdb786-fb8a0.png 590w,\n/static/profile-3-bbca9efff58870ac09624d413fcdb786-526de.png 885w,\n/static/profile-3-bbca9efff58870ac09624d413fcdb786-fa2eb.png 1180w,\n/static/profile-3-bbca9efff58870ac09624d413fcdb786-7615a.png 1720w"\n        sizes="(max-width: 590px) 100vw, 590px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>According to <a href="https://github.com/aspnet/EntityFrameworkCore/issues/12440#issuecomment-399158858">ajvickers</a>:</p>\n<blockquote>\n<p>When AddDbContext is called it ensures certain services used by EF are added to the service provider.\nFor example, ILoggerFactory. Since this is done for every context instance, it’s equivalent to what is described in #10211.\nRegistering the context as a singleton is generally not a good idea even in tests since it should never be registered as singleton in any real app.\nAssuming that you want to keep it this way, probably the best way to tackle this is to take over management of the internal service provider in your tests.\nThis will stop EF from building and caching the internal service provider for you.</p>\n</blockquote>\n<p>Okay, so that helps a lot and I now have a much better understanding of what’s going on.\nFrom this response I gathered a few things:</p>\n<ol>\n<li>We don’t want to call <code class="language-text">AdDbContext</code> multiple times in the same process for the same <code class="language-text">DbContext</code> implementation.</li>\n<li>Registering the <code class="language-text">DbContext</code> as a singleton is not ideal.</li>\n<li>There will be performance consequences if we try to hijack EF’s internal service provider.</li>\n</ol>\n<h2>Caching Test Servers</h2>\n<p>So, the very first problem was our fixture was creating a new <code class="language-text">TestServer</code> instance\nand calling <code class="language-text">AddDbContext</code> for every test. Based on the information discovered above,\nthis is a bad idea.</p>\n<p>Depending on what version of EF Core you’re running, you may even get a nice build warning that\npoints out the issue:</p>\n<div class="gatsby-highlight">\n      <pre class="language-text"><code class="language-text">warn: Microsoft.EntityFrameworkCore.Infrastructure[10402]\nMore than twenty &#39;IServiceProvider&#39; instances have been created for internal use by Entity Framework.\nThis is commonly caused by injection of a new singleton service instance into every DbContext instance.\nFor example, calling UseLoggerFactory passing in a new instance each time--see https://go.microsoft.com/fwlink/?linkid=869049 for more details.\nConsider reviewing calls on &#39;DbContextOptionsBuilder&#39; that may require new service providers to be built.</code></pre>\n      </div>\n<p>So, the first and most obvious step was to cache our <code class="language-text">TestServer</code> instances.\nWe wouldn’t restart our production web app after each request, so why should we do it in our tests?\nThe implementation is pretty straightforward, so I’ll direct you over to the GitHub repo so you can see it yourself.\nI define a <a href="https://github.com/jaredcnance/DotnetTestAbstractions/blob/27851f18f83c234512e492ca5122fcf5b4d54035/src/DotnetTestAbstractions/Fixtures/TestServerCache.cs#L10"><code class="language-text">TestServerCache</code></a>\nthat creates and configures the server and then the fixture <a href="https://github.com/jaredcnance/DotnetTestAbstractions/blob/27851f18f83c234512e492ca5122fcf5b4d54035/src/DotnetTestAbstractions/Fixtures/TestServerFixture.cs#L43">can just fetch it from the cache</a>.</p>\n<h2>Sharing Ambient Scope</h2>\n<p>Now that we’re re-using <code class="language-text">TestServer</code> instances, we still need a way to share <code class="language-text">DbContext</code> instances.\nAnd since our previous approach relied on a singleton DI registration, this would mean that every single test would get the same <code class="language-text">DbContext</code> instance which isn’t what we want.\nThe reason we couldn’t register it as a scoped service is because the scope is created and disposed during the lifetime of the request.\nWe need access to the scope before and after the request.</p>\n<p>Instead, we have two options:</p>\n<ol>\n<li>Share the database connection</li>\n<li>Share the DI request scope</li>\n</ol>\n<p>Option 1 would require changing application code to support tests.\nIt is also a very minimal solution that supports a single use case.\nOption 2 would allow us to inspect the state of any scoped service the same way the application code would.\nIn order to maximize the number of covered use cases and not be required to change application code, I decided to go with #2.</p>\n<p>There is an <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.iservicescopefactory?view=aspnetcore-2.1"><code class="language-text">IServiceScopeFactory</code></a>\ninterface we can implement to define our our scope for dependency injection. Whenever a service attempts to access the <code class="language-text">RequestServices</code>, the <code class="language-text">RequestServicesFeature</code>\n<a href="https://github.com/aspnet/Hosting/blob/a8c0970cde72242c40534c6c56a99f1d2ee6827a/src/Microsoft.AspNetCore.Hosting/Internal/RequestServicesFeature.cs#L29-L39">ensures that an <code class="language-text">IServiceScope</code> exists</a>\nby calling <code class="language-text">IServiceScopeFactory.CreateScope()</code>. Since this was written against an injected interface, we can override the implementation and inject our own <code class="language-text">IServiceScopeFactory</code>.\nThis would let us create the scope outside of the web request and return the existing scope when the middleware tries to create it.</p>\n<p>There are a few requirements of this approach that should be mentioned:</p>\n<ul>\n<li>Our test should create an “ambient scope” that is available to the test and also to the web request.</li>\n<li>The <code class="language-text">IServiceScopeFactory</code> has to be added to the application container.</li>\n<li>Multiple tests should not share an <code class="language-text">IServiceScope</code>.</li>\n<li>When the middleware tries to dispose the scope, it should be a no-op. This allows us to continue using the scope after the request has ended.</li>\n</ul>\n<p>In order to satisfy these requirements, I decided to store the scopes in an\n<a href="https://msdn.microsoft.com/en-us/library/dn906268(v=vs.110).aspx"><code class="language-text">AsyncLocal</code></a> member on the factory.\nFrom the docs:</p>\n<blockquote>\n<p><strong>AsyncLocal<T> Class</strong>\nRepresents ambient data that is local to a given asynchronous control flow, such as an asynchronous method.</p>\n</blockquote>\n<p>An example implementation might look like:</p>\n<div class="gatsby-highlight">\n      <pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AsyncLocalServiceScopeFactory</span> <span class="token punctuation">:</span> IServiceScopeFactory\n<span class="token punctuation">{</span>\n    <span class="token keyword">private</span> <span class="token keyword">static</span> AsyncLocal<span class="token operator">&lt;</span>IServiceScope<span class="token operator">></span> _asyncLocalScope <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncLocal</span><span class="token operator">&lt;</span>IServiceScope<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">public</span> IServiceScope <span class="token function">CreateScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span>_asyncLocalScope<span class="token punctuation">.</span>Value <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>\n            <span class="token operator">?</span> _asyncLocalScope<span class="token punctuation">.</span>Value\n            <span class="token punctuation">:</span> <span class="token function">CreateAmbientScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token keyword">static</span> IServiceScope <span class="token function">CreateAmbientScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">{</span>\n        <span class="token comment">// what now...?</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre>\n      </div>\n<p>This would allow us to create the scope ourselves, outside of the web request:</p>\n<div class="gatsby-highlight">\n      <pre class="language-csharp"><code class="language-csharp"><span class="token keyword">var</span> scope <span class="token operator">=</span> AsyncLocalServiceScopeFactory<span class="token punctuation">.</span><span class="token function">CreateAmbientScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre>\n      </div>\n<p>However, we still need to prevent the ASP.Net middleware from disposing our scope.\nWe can do this by making <code class="language-text">IDisposable.Dipose()</code> a no-op and exposing an <code class="language-text">ActuallyDispose()</code>\nmethod to the test.</p>\n<div class="gatsby-highlight">\n      <pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServiceScope</span> <span class="token punctuation">:</span> IServiceScope\n<span class="token punctuation">{</span>\n    <span class="token keyword">public</span> IServiceProvider ServiceProvider <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* Do nothing 😬 */</span> <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ActuallyDispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* Dispose of our scope */</span><span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre>\n      </div>\n<h3>Okay, but where does the service lifecycle management take place?</h3>\n<p>So far we haven’t actually resolved any services from this scope and we haven’t wired it\nup to an actual container so it’s pretty much useless right now.\nComponent/service lifecycle management is not something that I really wanted to roll myself and the\nexisting types in Microsoft.Extensions.DependencyInjection seem pretty limited.</p>\n<p>So, I turned to <a href="https://github.com/autofac/Autofac">Autofac</a> — a very mature IoC container solution\nthat provides full support for scopes and nested scopes (something I’ll dive into shortly).</p>\n<p>Using Autofac, our <code class="language-text">AsyncLocalServiceScopeFactory</code> class becomes:</p>\n<div class="gatsby-highlight">\n      <pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AsyncLocalServiceScopeFactory</span> <span class="token punctuation">:</span> IServiceScopeFactory\n<span class="token punctuation">{</span>\n    <span class="token keyword">private</span> <span class="token keyword">static</span> AsyncLocal<span class="token operator">&lt;</span>ServiceScope<span class="token operator">></span> _asyncLocalScope <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncLocal</span><span class="token operator">&lt;</span>ServiceScope<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> IContainer _container<span class="token punctuation">;</span>\n\n    <span class="token keyword">public</span> IServiceScope <span class="token function">CreateScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* unchanged */</span> <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token keyword">static</span> IServiceScope <span class="token function">CreateAmbientScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">{</span>\n        <span class="token keyword">var</span> lifetimeScope <span class="token operator">=</span> _container<span class="token punctuation">.</span><span class="token function">BeginLifetimeScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">var</span> scope <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceScope</span><span class="token punctuation">(</span>lifetimeScope<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        _asyncLocalScope<span class="token punctuation">.</span>Value <span class="token operator">=</span> scope<span class="token punctuation">;</span>\n        <span class="token keyword">return</span> scope<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre>\n      </div>\n<p>I’ve also passed the Autofac <code class="language-text">ILifetimeScope</code> to the <code class="language-text">ServiceScope</code> implementation which will\nresolve services from the scope itself.\nIt will also dispose the scope when our test calls <code class="language-text">ActuallyDispose</code>:</p>\n<div class="gatsby-highlight">\n      <pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServiceScope</span> <span class="token punctuation">:</span> IServiceScope<span class="token punctuation">,</span> IServiceProvider\n<span class="token punctuation">{</span>\n    <span class="token keyword">private</span> <span class="token keyword">readonly</span> ILifetimeScope _lifetimeScope<span class="token punctuation">;</span>\n\n    <span class="token keyword">public</span> <span class="token function">ServiceScope</span><span class="token punctuation">(</span>ILifetimeScope lifetimeScope<span class="token punctuation">)</span>\n    <span class="token punctuation">{</span>\n        _lifetimeScope <span class="token operator">=</span> lifetimeScope<span class="token punctuation">;</span>\n        ServiceProvider <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> IServiceProvider ServiceProvider <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>\n    <span class="token keyword">public</span> <span class="token keyword">object</span> <span class="token function">GetService</span><span class="token punctuation">(</span>Type serviceType<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> _lifetimeScope<span class="token punctuation">.</span><span class="token function">Resolve</span><span class="token punctuation">(</span>serviceType<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* Do nothing 😬 */</span> <span class="token punctuation">}</span>\n    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ActuallyDispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> _lifetimeScope<span class="token punctuation">.</span><span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre>\n      </div>\n<p>At this point the test and the web request share the exact same scope.\nThis is definitely a step in the right direction and should handle most cases.\nHowever, there are a few cases where this falls short.\nFor example, the Asp.Net Core Identity <code class="language-text">UserStore</code> <a href="https://github.com/aspnet/Identity/issues/1068">caches entities in the scope</a>.\nThis would prevent the following test from passing:</p>\n<div class="gatsby-highlight">\n      <pre class="language-csharp"><code class="language-csharp">user<span class="token punctuation">.</span>Password <span class="token operator">=</span> <span class="token string">"myNewPassword"</span><span class="token punctuation">;</span>\n<span class="token comment">// send a request to update the user\'s password</span>\n<span class="token keyword">await</span> <span class="token function">PatchUserAsync</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">// send a request to login</span>\n<span class="token keyword">await</span> <span class="token function">PostLoginAsync</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre>\n      </div>\n<p>The reason this fails is because we are deviating a bit from the way ASP.Net Core request scopes should be handled by the application.\nIn order to better approximate the behavior of an actual web app,\nwe should give each web request its own scope but still provide access to services registered against the ambient scope.\nThe below illustration shows the different possibilities.</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/request-scope-illustrations-6f736aedd3940799e499127e6bcbc41f-ec9c6.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 590px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 142.85714285714286%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAdCAYAAACqhkzFAAAACXBIWXMAAAsSAAALEgHS3X78AAAFD0lEQVRIx3VVaXfaRhT1//8dXU7b5LhtHG9xYhtcNkloX9CCJCSEEJLYwY6d3D4NDsVx+uGeN4yYO2/m3fvmaLNZoML2OTKsK8xfYL2aYbWc7rGu8DxXxW84KrIhikmCLEtQjUsal/kIRZ5iWuxQFmNaWO4WVeQHGxySMUJON8BZHppWH0Kvj67dR9sOwNkhJDeAE4bomSpGyYAynaFIA0wn8YuMXxCaxRbWAujNvsCcfSXgGV+gTZ+QbJ6QjiIijLCcjlGMfORDD4tpxjJ9RaiM5lCyDdTJhuIayngNebSGmm1h5iv05/cI4wGRDmjBFHnSRzke7IleEUrpEu87Gt61ZBbft1S8ueHw5x2PuhnAWz4hGkYYE+H9donVotwv/uEdWuMZPsgeTonsUrRx2XVwJbu0gQIuKtGbf4UVjZClEVPCi0r/KEN/MoU+fYRePEDPH3eoxuw3oXyCFY8xGccvCP83w2FeYDhfwyk3jMDId0RGUY3vqTCPUOKMMoyZHpeL1xkeEh/FUR9J7MMP+/CCPlzfg913YXsOegTDdWC6NhEVeLhfsSzvtzvhHx7/G+nROB2SJGK69Bij4YDIQ4oRi3HoIx74SKIQQ6p0hWS4k1Al/P1RD4R+xNHlf7xo4vTdNc5ObnF13tjFiwa4Jom+ZYInCG2LQeRs9ltTNNzfLzErRkzo+wwVquy74xv89ssJ/j7+iJO/rvH293M2Fto2XCtDT08IIwaboEkDKJLOjp76OkHDvKwynuNI7pqQeI8W9yC0dugSuAbNcw50KYQmBhQDNjbVGEo3gCSolOGCWbESe3XHLMOK0JBj8BR1J4DZ86CYHjTyt2CSv00fSo/IaN5yXNrcJELyeVdjGa6+v0NFtKAIPlRawEcZ2v0UTQIf5RCTKbphCjlM4C0+I16uIQo6/T+ELO6O/L2MGKFaHUGz8LbG4Y9rDj+f13FcF3B8J+CiLaFFG5jlA8IZ+Vw0GaEiGbsMv2mwImWEUkXoQzQcstoEEkEZJOAoM96LoEQp2e8ztHwDq1xDov9r4gCqbO4JV8sDpwjkYZn30WmrkFUbkmiw4/B0NLGro8NpaDRlNOl7s6OiRVISOx4RGj8mDPrkEKeCB6dnw7HIIWYVbdgE167gwO09g8YOzVUNd7uZv3ZK1eMWVPKqxS+pNS3mBZPAfJ5jRk10NptgXmE+oW/5f99nBft/pb0XVTY0A+fvazg9uaZ4i8uzOi5Ob3H7qYPmHRWE0G4o6DRUdJoajXUIHQt16pmVZdfLAmUW/Zdhz3TRrGv4RJa7OvsHn8iGZ+SWRk2BbaQwFHJFl+6MoQ+NYNIc37KYt8vUx8hTMMsTlumRqfdIrA541YXsDCH1qLLuCJZL4uV1tKhobZrvOjFkL4boRFD7EWXYpgyH9LZQ842oG9F17B4pIuRbBlSSxx0RtYIMt0RqlFuqOlmRKn2t+bhSfFxKtPFwgf7iEbWbFnUlarrVs3DwJBChTf41YJD23tzy+Om8hg+SCyXfglccdIXde/PrxzZqXgZx8kAv5GfUah2kSfyi0rs3hQQtUDtykgx6toQ6nCBYPcFeA13dJ8/qMJICMgm+l05hpjNCiRvafDxK9oT7DC06cuuOHqQ2jy4vQ+Cosk0etaaIO7Jesy5RgQQCj8Zth6FZpxeRLJqlyf6d2Qs7n4yoWiEG1J19z2UIfBcDQhh4iKhjR4PgIAaIowo+0+T3j9W/MPA7jgIgSU0AAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"\n        alt="Iterations of the design"\n        title=""\n        src="/static/request-scope-illustrations-6f736aedd3940799e499127e6bcbc41f-fb8a0.png"\n        srcset="/static/request-scope-illustrations-6f736aedd3940799e499127e6bcbc41f-1a291.png 148w,\n/static/request-scope-illustrations-6f736aedd3940799e499127e6bcbc41f-2bc4a.png 295w,\n/static/request-scope-illustrations-6f736aedd3940799e499127e6bcbc41f-fb8a0.png 590w,\n/static/request-scope-illustrations-6f736aedd3940799e499127e6bcbc41f-ec9c6.png 707w"\n        sizes="(max-width: 590px) 100vw, 590px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>We have currently implemented scenario 1 and I am in the process of finishing support for scenarios 1-2.\nTo do this we need to create child scopes (one of the reason I chose AutoFac earlier) that have access to the ambient\nscope. One of the challenges here is that if I register a <code class="language-text">DbContext</code> in the ambient scope and in the child scope\n(say via a <code class="language-text">Startup</code> class), the child scoped instance would be resolved instead of the ambient instance.</p>\n<p>This is one of the challenges I’m currently working on, but for now the current solution should be satisfactory for\nat least 95% of use cases.</p>\n<h2>So, Where’s The Abstraction?</h2>\n<p>I would love to see this officially supported by Microsoft.\nBut until then, I have provided a library you can use so you don’t need to worry about the details.</p>\n<ul>\n<li><a href="https://github.com/jaredcnance/DotnetTestAbstractions">Source Code</a></li>\n<li><a href="https://www.nuget.org/packages/DotnetTestAbstractions">NuGet Package</a></li>\n</ul>\n<p>If you have any questions or are interested in supporting this project, feel free to reach out to me\non Twitter <a href="https://twitter.com/jaredcnance">@jaredcnance</a>.</p>',
frontmatter:{title:"A Better Story for Asp.Net Core Integration Testing",date:"July 05, 2018",description:null}}},pathContext:{slug:"/a-better-story-for-asp-net-core-integration-testing/",previous:{fields:{slug:"/leveling-up-your-dotnet-testing-transactional-integration-testing-in-asp-net-core/"},frontmatter:{title:"Leveling Up Your .Net Testing Patterns - Part II Transactional Integration Testing"}},next:!1}}}});
//# sourceMappingURL=path---a-better-story-for-asp-net-core-integration-testing-bbff0605d044e5771da4.js.map